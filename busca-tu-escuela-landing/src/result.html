<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SchoolFinder ‚Ä¢ Resultados</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="styles/result.css">
</head>
<body class="sf-results list-compact"><!-- compacto por defecto -->

<!-- ===== NAV ===== -->
<nav class="navbar navbar-expand-lg sf-navbar sticky-top">
  <div class="container">
    <a class="navbar-brand sf-brand" href="index.html" aria-label="SchoolFinder - Inicio">
      <div class="brand-icon">
        <i class="bi bi-mortarboard-fill"></i>
      </div>
      <span class="brand-text">SchoolFinder</span>
    </a>

    <div class="d-flex align-items-center gap-2 order-lg-2">
      <button id="density" class="btn btn-sm sf-btn-ghost" title="Cambiar densidad">
        <i class="bi bi-arrows-expand"></i> Compacto
      </button>
      <button id="savedBtn" class="btn btn-sm sf-btn-ghost position-relative" title="Guardados">
        <i class="bi bi-bookmark"></i>
        <span id="savedCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
      </button>
      <button id="compareBtn" class="btn btn-sm sf-btn-primary" title="Comparar escuelas guardadas" data-bs-toggle="offcanvas" data-bs-target="#compareOffcanvas" style="display: none;">
        <i class="bi bi-arrow-left-right"></i> Comparar
      </button>
      <div class="nav-item dropdown">
        <button class="btn btn-language dropdown-toggle" id="languageDropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <svg class="flag-icon flag-pr" width="20" height="14" viewBox="0 0 20 14">
            <rect width="20" height="2.8" fill="#FF0000"/>
            <rect y="2.8" width="20" height="2.8" fill="#FFFFFF"/>
            <rect y="5.6" width="20" height="2.8" fill="#FF0000"/>
            <rect y="8.4" width="20" height="2.8" fill="#FFFFFF"/>
            <rect y="11.2" width="20" height="2.8" fill="#FF0000"/>
            <polygon points="0,0 8,0 8,14 0,14" fill="#0033CC"/>
            <polygon points="4,3.5 4.5,5 6,5 4.8,5.8 5.3,7.3 4,6.5 2.7,7.3 3.2,5.8 2,5 3.5,5" fill="#FFFFFF"/>
          </svg>
          <span class="lang-text">ES</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end language-menu" aria-labelledby="languageDropdown">
          <li>
            <button class="dropdown-item language-item active" data-lang="es">
              <svg class="flag-icon flag-pr" width="20" height="14" viewBox="0 0 20 14">
                <rect width="20" height="2.8" fill="#FF0000"/>
                <rect y="2.8" width="20" height="2.8" fill="#FFFFFF"/>
                <rect y="5.6" width="20" height="2.8" fill="#FF0000"/>
                <rect y="8.4" width="20" height="2.8" fill="#FFFFFF"/>
                <rect y="11.2" width="20" height="2.8" fill="#FF0000"/>
                <polygon points="0,0 8,0 8,14 0,14" fill="#0033CC"/>
                <polygon points="4,3.5 4.5,5 6,5 4.8,5.8 5.3,7.3 4,6.5 2.7,7.3 3.2,5.8 2,5 3.5,5" fill="#FFFFFF"/>
              </svg>
              <div class="lang-info">
                <span class="lang-name">Espa√±ol</span>
                <small class="lang-region">Puerto Rico</small>
              </div>
              <i class="bi bi-check-lg lang-check"></i>
            </button>
          </li>
          <li>
            <button class="dropdown-item language-item" data-lang="en">
              <svg class="flag-icon flag-us" width="20" height="14" viewBox="0 0 20 14">
                <rect width="20" height="14" fill="#B22234"/>
                <rect y="1" width="20" height="1" fill="#FFFFFF"/>
                <rect y="3" width="20" height="1" fill="#FFFFFF"/>
                <rect y="5" width="20" height="1" fill="#FFFFFF"/>
                <rect y="7" width="20" height="1" fill="#FFFFFF"/>
                <rect y="9" width="20" height="1" fill="#FFFFFF"/>
                <rect y="11" width="20" height="1" fill="#FFFFFF"/>
                <rect y="13" width="20" height="1" fill="#FFFFFF"/>
                <rect width="8" height="7" fill="#3C3B6E"/>
              </svg>
              <div class="lang-info">
                <span class="lang-name">English</span>
                <small class="lang-region">United States</small>
              </div>
              <i class="bi bi-check-lg lang-check"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<!-- ===== HERO ===== -->
<header class="sf-band-hero sf-hero-soft">
  <div class="container">
    <div class="d-flex align-items-center gap-3">
      <div class="hero-icon">
        <i class="bi bi-search"></i>
      </div>
      <div>
        <h1 class="display-6 fw-bold mb-1">
          <span class="hero-number">845</span> Centros educativos en <span class="text-primary">Puerto Rico</span>
        </h1>
        <p class="text-muted mb-0">Estos son los centros educativos encontrados en nuestra plataforma (no es un ranking).</p>
      </div>
    </div>
  </div>
</header>

<!-- ===== TOOLBAR MEJORADO ===== -->
<div class="sf-toolbar">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <ul class="nav sf-results-tabs">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabTodos" type="button">
              <i class="bi bi-grid-3x3-gap"></i>
              <span>Todos</span>
              <span class="tab-count">845</span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabTop" type="button">
              <i class="bi bi-trophy"></i>
              <span>Top</span>
              <span class="tab-count">25</span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabBilingues" type="button">
              <i class="bi bi-translate"></i>
              <span>Biling√ºes</span>
              <span class="tab-count">156</span>
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabValorados" type="button">
              <i class="bi bi-star-fill"></i>
              <span>M√°s valorados</span>
              <span class="tab-count">78</span>
            </button>
          </li>
        </ul>
      </div>
      <div class="col-lg-4">
        <div class="d-flex align-items-center justify-content-end gap-3">
          <button id="btnMapMode" class="btn sf-btn-map" aria-pressed="false">
            <i class="bi bi-geo-alt"></i>
            <span>Ver mapa</span>
          </button>
          <div class="sort-control">
            <label class="sort-label">Ordenar por:</label>
            <select id="orderSelect" class="form-select sf-select">
              <option value="relevancia">üìä Relevancia</option>
              <option value="rating">‚≠ê Mejor valorados</option>
              <option value="cercanos">üìç M√°s cercanos</option>
              <option value="alfabetico">üî§ A-Z</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== LISTA ===== -->
<main id="listView" class="py-4">
  <div class="container">

    <!-- Filtros compactos -->
    <div class="sf-compact-filters mb-3">
      <div class="row g-2 align-items-center">
        <!-- B√∫squeda principal -->
        <div class="col-lg-4 col-md-6">
          <div class="sf-input-compact">
            <i class="bi bi-search"></i>
            <input id="fQuery" placeholder="Busca por nombre o c√≥digo..." autocomplete="off">
          </div>
        </div>
        
        <!-- Filtros de selecci√≥n -->
        <div class="col-lg-2 col-md-3 col-sm-6">
          <div class="sf-select-compact">
            <i class="bi bi-mortarboard"></i>
            <select id="fGrades">
              <option value="">Grados</option>
              <option>Inicial</option>
              <option>Primaria</option>
              <option>Secundaria</option>
            </select>
          </div>
        </div>
        
        <div class="col-lg-2 col-md-3 col-sm-6">
          <div class="sf-select-compact">
            <i class="bi bi-geo-alt"></i>
            <select id="fMunicipios">
              <option value="">Municipios</option>
              <option>San Juan</option>
              <option>Bayam√≥n</option>
              <option>Carolina</option>
            </select>
          </div>
        </div>
        
        <div class="col-lg-2 col-md-3 col-sm-6">
          <div class="sf-select-compact">
            <i class="bi bi-star-fill"></i>
            <select id="fStars">
              <option value="">Estrellas</option>
              <option value="5">5 ‚≠ê</option>
              <option value="4">4+ ‚≠ê</option>
              <option value="3">3+ ‚≠ê</option>
            </select>
          </div>
        </div>
        
        <!-- Bot√≥n y checkbox -->
        <div class="col-lg-2 col-md-3 col-sm-6">
          <button id="btnApplyTop" class="sf-btn-compact">
            <i class="bi bi-funnel-fill"></i>
            Aplicar
          </button>
        </div>
      </div>
      
      <!-- Opci√≥n Head Start compacta -->
      <div class="sf-checkbox-compact mt-2">
        <input id="fHeadStart" type="checkbox">
        <label for="fHeadStart">
          <i class="bi bi-check2"></i>
          <span>Incluir Centros Head Start</span>
        </label>
      </div>
    </div>

    <div class="row g-4">
      <!-- Sidebar -->
      <aside class="col-lg-3">
        <div class="sf-sidebar-filters">

          <!-- Active Filters Preview -->
          <div class="sf-active-filters" id="activeFiltersPreview" style="display: none;">
            <div class="sf-active-header">
              <i class="bi bi-filter-circle"></i>
              <span>Filtros aplicados</span>
            </div>
            <div class="sf-active-tags" id="activeFiltersTags"></div>
            <button class="sf-clear-filters" id="clearAllFilters">
              <i class="bi bi-x-circle"></i>
              Limpiar filtros
            </button>
          </div>
          
          <!-- Filtros Populares -->
          <div class="sf-filter-section">
            <div class="sf-section-header">
              <i class="bi bi-funnel"></i>
              <span>Filtros populares</span>
              <span class="sf-section-badge" id="popularBadge">0</span>
            </div>
            
            <div class="sf-filter-options">
              <label class="sf-option" data-filter="fast">
                <input type="checkbox" id="pFast" onchange="updateFilters()">
                <div class="sf-option-content">
                  <div class="sf-option-check">
                    <i class="bi bi-check"></i>
                  </div>
                  <i class="bi bi-lightning-charge"></i>
                  <div class="sf-option-text">
                    <span class="sf-option-title">Respuesta r√°pida</span>
                    <span class="sf-option-desc">Contacto en 24h</span>
                  </div>
                  <span class="sf-option-count">127</span>
                </div>
              </label>
              
              <label class="sf-option" data-filter="opendays">
                <input type="checkbox" id="pOpen" onchange="updateFilters()">
                <div class="sf-option-content">
                  <div class="sf-option-check">
                    <i class="bi bi-check"></i>
                  </div>
                  <i class="bi bi-calendar-event"></i>
                  <div class="sf-option-text">
                    <span class="sf-option-title">Con Open Days</span>
                    <span class="sf-option-desc">D√≠as de puertas abiertas</span>
                  </div>
                  <span class="sf-option-count">89</span>
                </div>
              </label>
              
              <label class="sf-option" data-filter="photos">
                <input type="checkbox" id="pPhotos" onchange="updateFilters()">
                <div class="sf-option-content">
                  <div class="sf-option-check">
                    <i class="bi bi-check"></i>
                  </div>
                  <i class="bi bi-camera"></i>
                  <div class="sf-option-text">
                    <span class="sf-option-title">Con fotos</span>
                    <span class="sf-option-desc">Galer√≠a disponible</span>
                  </div>
                  <span class="sf-option-count">234</span>
                </div>
              </label>
            </div>
          </div>

          <!-- Filtro de Distancia -->
          <div class="sf-filter-section">
            <div class="sf-section-header">
              <i class="bi bi-geo-alt"></i>
              <span>Distancia</span>
              <span class="sf-section-badge" id="distanceBadge">0</span>
            </div>
            
            <div class="sf-filter-options">
              <div class="sf-distance-filter">
                <div class="sf-distance-header">
                  <span class="sf-distance-label" id="distanceLabel">Cualquier distancia</span>
                  <span class="sf-distance-value" id="distanceValue"></span>
                </div>
                
                <div class="sf-distance-slider">
                  <input type="range" id="distanceRange" 
                         min="0" max="50" step="1" value="50"
                         class="sf-range-input"
                         oninput="updateDistanceFilter(this.value)">
                  <div class="sf-range-track">
                    <div class="sf-range-fill" id="distanceFill"></div>
                  </div>
                </div>
                
                <div class="sf-distance-presets">
                  <button class="sf-distance-preset" onclick="setDistanceFilter(5)">5 mi</button>
                  <button class="sf-distance-preset" onclick="setDistanceFilter(10)">10 mi</button>
                  <button class="sf-distance-preset" onclick="setDistanceFilter(25)">25 mi</button>
                  <button class="sf-distance-preset active" onclick="setDistanceFilter(50)">Todo</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Tipo de Centro -->
          <div class="sf-filter-section">
            <div class="sf-section-header">
              <i class="bi bi-building"></i>
              <span>Tipo de Centro</span>
              <span class="sf-section-badge" id="typeBadge">0</span>
            </div>
            
            <div class="sf-filter-options">
              <label class="sf-option sf-option-simple" data-filter="jardin">
                <input type="checkbox" id="tJardin" onchange="updateFilters()">
                <div class="sf-option-content">
                  <div class="sf-option-check">
                    <i class="bi bi-check"></i>
                  </div>
                  <i class="bi bi-flower1"></i>
                  <span class="sf-option-title">Jard√≠n Infantil</span>
                  <span class="sf-option-count">312</span>
                </div>
              </label>
              
              <label class="sf-option sf-option-simple" data-filter="colegio">
                <input type="checkbox" id="tColegio" onchange="updateFilters()">
                <div class="sf-option-content">
                  <div class="sf-option-check">
                    <i class="bi bi-check"></i>
                  </div>
                  <i class="bi bi-mortarboard"></i>
                  <span class="sf-option-title">Colegio</span>
                  <span class="sf-option-count">445</span>
                </div>
              </label>
              
              <label class="sf-option sf-option-simple" data-filter="instituto">
                <input type="checkbox" id="tInstituto" onchange="updateFilters()">
                <div class="sf-option-content">
                  <div class="sf-option-check">
                    <i class="bi bi-check"></i>
                  </div>
                  <i class="bi bi-bank"></i>
                  <span class="sf-option-title">Instituto</span>
                  <span class="sf-option-count">88</span>
                </div>
              </label>
            </div>
          </div>

          <!-- Loading State -->
          <div class="sf-loading-state" id="filtersLoading" style="display: none;">
            <div class="sf-loading-spinner"></div>
            <span>Actualizando resultados...</span>
          </div>

        </div>
      </aside>

      <!-- Resultados -->
      <section class="col-lg-9">
        <div id="resultsList"></div>

        <!-- Skeletons -->
        <div id="skeletons" class="d-none">
          <div class="card-skeleton mb-3">
            <div class="skel line" style="width:60%"></div>
            <div class="skel line" style="width:90%"></div>
            <div class="skel line" style="width:40%"></div>
          </div>
          <div class="card-skeleton mb-3">
            <div class="skel line" style="width:70%"></div>
            <div class="skel line" style="width:85%"></div>
            <div class="skel line" style="width:50%"></div>
          </div>
        </div>

        <!-- Fallback: bot√≥n cargar m√°s -->
        <div class="d-flex justify-content-center mt-3">
          <button id="loadMore" class="btn sf-btn-ghost">Cargar m√°s</button>
        </div>

        <!-- Sentinela para IntersectionObserver -->
        <div id="ioSentinel" class="py-3"></div>
      </section>
    </div>
  </div>
</main>

<!-- ===== MAPA ===== -->
<section id="mapView" class="py-3 sf-map-view">
  <div class="container">
    <div class="p-3 mb-2 border rounded-3 bg-white shadow-sm">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-geo-alt-fill text-primary"></i>
          <strong>Mapa de escuelas</strong>
          <span class="text-muted small">Explora escuelas por ubicaci√≥n</span>
        </div>
        <button id="btnBackList" class="btn btn-sm sf-btn-ghost">
          <i class="bi bi-list-ul"></i> Volver a la lista
        </button>
      </div>
    </div>
    <div id="mapFull" class="sf-map-full border"></div>
  </div>
</section>

<!-- ===== TEMPLATE TARJETA ===== -->
<template id="cardTemplate">
  <article class="sf-card" data-id="" data-rating="" data-lat="" data-lng="">
    <!-- Header con informaci√≥n principal -->
    <div class="d-flex gap-3 align-items-start mb-2">
      <img class="sf-logo" src="" alt="logo" loading="lazy"/>
      <div class="flex-grow-1">
        <div class="d-flex flex-wrap justify-content-between align-items-start">
          <a class="sf-title h6 text-decoration-none" href="#" target="_blank"></a>
          <div class="d-flex align-items-center gap-2">
            <span class="badge-state ok d-none"><i class="bi bi-patch-check-fill"></i> Apta</span>
            <span class="badge-state warn d-none"><i class="bi bi-exclamation-triangle-fill"></i> Reubicada</span>
            <button class="btn btn-sm sf-btn-ghost js-save" aria-pressed="false" title="Guardar"><i class="bi bi-bookmark"></i></button>
          </div>
        </div>

        <div class="sf-meta-row d-flex flex-wrap align-items-center small text-muted">
          <span class="pill-rating"><span class="stars"></span><span class="rate-text"></span></span>
          <span class="loc"><i class="bi bi-geo-alt"></i> <span class="municipio"></span></span>
          <span class="distance-info d-none"><i class="bi bi-compass"></i> <span class="distance"></span></span>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n de la escuela -->
    <div class="sf-kv-grid sf-dense mb-1">
      <div class="sf-kv"><small>C√≥digo</small><span class="codigo"></span></div>
      <div class="sf-kv"><small>Municipio</small><span class="municipio"></span></div>
      <div class="sf-kv"><small>Horario</small><span class="horario"></span></div>
      <div class="sf-kv"><small>Modalidad</small><span class="modalidad"></span></div>
      <div class="sf-kv"><small>Niveles</small><span class="niveles"></span></div>
      <div class="sf-kv"><small>Especialidad</small><span class="especialidad"></span></div>
    </div>

    <!-- Acciones y badges en la misma fila -->
    <div class="sf-card-actions d-flex justify-content-between align-items-center border-top">
      <div class="sf-badges-condensed d-flex flex-wrap gap-1">
        <span class="badge-attr tipo"></span>
        <span class="badge-attr genero"></span>
        <span class="badge-attr idioma"></span>
      </div>
      
      <div class="sf-card-actions-buttons d-flex gap-2">
        <button class="btn sf-btn-profile js-quickview" data-id="10001"
          data-bs-toggle="offcanvas" data-bs-target="#schoolDrawer"
          aria-controls="schoolDrawer">
          <i class="bi bi-eye me-1"></i>Ver Perfil
        </button>
        
        <button class="btn sf-btn-directions js-directions" data-id="10001"
          title="C√≥mo llegar a esta escuela">
          <i class="bi bi-geo-alt me-1"></i>C√≥mo llegar
        </button>
      </div>
    </div>
  </article>
</template>


<!-- OFFCANVAS: Perfil de la escuela -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="schoolDrawer" aria-labelledby="schoolDrawerLabel">
  <!-- Header con mapa y informaci√≥n de contacto -->
  <div class="school-header">
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    
    <!-- Mapa -->
    <div class="school-map">
      <div id="drawerMap" class="map-container"></div>
    </div>
    
    <!-- Informaci√≥n de contacto -->
    <div class="contact-info">
      <div class="contact-item">
        <i class="bi bi-geo-alt-fill"></i>
        <div>
          <label>Direcci√≥n</label>
          <span id="sdAddress">CALLE BAH√çA OESTE C-79</span>
        </div>
      </div>
      
      <div class="contact-item">
        <i class="bi bi-telephone-fill"></i>
        <div>
          <label>Tel√©fono</label>
          <span id="sdPhone">(787)737-4344</span>
        </div>
      </div>
      
      <div class="contact-item">
        <i class="bi bi-envelope-fill"></i>
        <div>
          <label>Correo electr√≥nico</label>
          <span id="sdEmail">024612@de.pr.gov</span>
        </div>
      </div>
    </div>
    
    <!-- Matr√≠cula en l√≠nea -->
    <div class="enrollment-banner">
      <div class="enrollment-icon">
        <i class="bi bi-laptop"></i>
      </div>
      <div class="enrollment-text">
        <strong>MATR√çCULA EN L√çNEA</strong>
        <small>Sistema de matr√≠cula del Departamento de Educaci√≥n</small>
      </div>
    </div>
  </div>

  <div class="offcanvas-body">
    <!-- T√≠tulo principal con logo -->
    <div class="school-title">
      <div class="school-logo">
        <i class="bi bi-building"></i>
      </div>
      <div class="title-content">
        <h4 id="schoolDrawerLabel">Detalles de la Escuela</h4>
      </div>
    </div>

    <!-- Informaci√≥n en 2 cards principales -->
    <div class="details-two-cards">
      <!-- Card 1: Informaci√≥n Acad√©mica -->
      <div class="details-card academic-info">
        <div class="card-header">
          <i class="bi bi-mortarboard"></i>
          <h6>Informaci√≥n Acad√©mica</h6>
        </div>
        <div class="card-content">
          <div class="info-row">
            <div class="info-item">
              <label>C√≥digo</label>
              <span id="sdCode">24612</span>
            </div>
            <div class="info-item">
              <label>Nivel</label>
              <span id="sdLevel">PRIMARIO</span>
            </div>
            <div class="info-item">
              <label>Grados</label>
              <span id="sdGrades">K - 5</span>
            </div>
          </div>
          <div class="info-row">
            <div class="info-item">
              <label>Regi√≥n Educativa</label>
              <span id="sdRegion">CAGUAS</span>
            </div>
            <div class="info-item">
              <label>Clasificaci√≥n</label>
              <span id="sdClasificacion">Others</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Card 2: Informaci√≥n Operacional -->
      <div class="details-card operational-info">
        <div class="card-header">
          <i class="bi bi-gear"></i>
          <h6>Informaci√≥n Operacional</h6>
        </div>
        <div class="card-content">
          <div class="info-row">
            <div class="info-item status-item">
              <label>Status</label>
              <span id="sdStatus" class="status-active">Apta para abrir</span>
            </div>
            <div class="info-item">
              <label>Estrategia Modalidad</label>
              <span id="sdModalidad">Horario Regular</span>
            </div>
          </div>
          <div class="info-row">
            <div class="info-item full-width">
              <label>Horario</label>
              <span id="sdHorario">Lunes a viernes 8:00AM - 3:00PM</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Star Rating Section -->
    <div class="rating-section">
      <div class="rating-header">
        <div class="rating-icon">
          <i class="bi bi-star-fill"></i>
        </div>
        <div class="rating-title">
          <h6>Star Rating</h6>
          <p>Desempe√±o de las escuelas en 3 dominios de rendimiento. Las escuelas reciben una calificaci√≥n de 1 a 5 estrellas. <a href="#">M√°s informaci√≥n</a></p>
        </div>
      </div>
      
      <div class="rating-categories">
        <div class="rating-category">
          <label>Aprovechamiento Acad√©mico</label>
          <div class="stars" id="sdAcademico">
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
          </div>
        </div>
        
        <div class="rating-category">
          <label>Calidad Escolar</label>
          <div class="stars" id="sdCalidad">
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
          </div>
        </div>
        
        <div class="rating-category">
          <label>Administraci√≥n Escolar</label>
          <div class="stars" id="sdAdmin">
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Proficiencia Section -->
    <div class="proficiency-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="bi bi-graph-up"></i>
        </div>
        <div class="section-title">
          <h6>Proficiencia</h6>
          <p>Porcentaje de estudiantes con desempe√±o proficiente o avanzado en las pruebas estandarizadas META-PR. <a href="#">M√°s informaci√≥n</a></p>
          <small>A√±o Acad√©mico: 2023-2024</small>
        </div>
      </div>
      
      <div class="proficiency-bars">
        <div class="proficiency-item">
          <div class="prof-header">
            <label>Espa√±ol</label>
            <span class="percentage" id="pEspanol">51.56%</span>
          </div>
          <div class="prof-bar">
            <div class="prof-fill" style="width: 51.56%" data-color="blue"></div>
            <div class="prof-target" style="left: 60%" data-label="Objetivo 60%"></div>
          </div>
          <div class="prof-stats">
            <span class="promedio">Promedio Isla: 52.52%</span>
          </div>
        </div>
        
        <div class="proficiency-item">
          <div class="prof-header">
            <label>Matem√°ticas</label>
            <span class="percentage" id="pMatematicas">77.34%</span>
          </div>
          <div class="prof-bar">
            <div class="prof-fill" style="width: 77.34%" data-color="red"></div>
            <div class="prof-target" style="left: 73%" data-label="73%"></div>
          </div>
          <div class="prof-stats">
            <span class="promedio">32.58%</span>
          </div>
        </div>
        
        <div class="proficiency-item">
          <div class="prof-header">
            <label>Ingl√©s</label>
            <span class="percentage" id="pIngles">80.47%</span>
          </div>
          <div class="prof-bar">
            <div class="prof-fill" style="width: 80.47%" data-color="green"></div>
            <div class="prof-target" style="left: 27%" data-label="27%"></div>
          </div>
          <div class="prof-stats">
            <span class="promedio">36.3%</span>
          </div>
        </div>
        
        <div class="proficiency-item">
          <div class="prof-header">
            <label>Ciencia</label>
            <span class="percentage" id="pCiencia">100%</span>
          </div>
          <div class="prof-bar">
            <div class="prof-fill" style="width: 100%" data-color="blue"></div>
            <div class="prof-target" style="left: 50%" data-label="50%"></div>
          </div>
          <div class="prof-stats">
            <span class="promedio">38.02%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- M√©tricas Cards -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-icon" style="background: var(--brand-500);">
          <i class="bi bi-person-check"></i>
        </div>
        <div class="metric-content">
          <h6>Tasa de Asistencia</h6>
          <p>Tasa de asistencia de los estudiantes.</p>
          <div class="metric-values">
            <span class="main-value" id="mAsistencia">88.58%</span>
            <span class="secondary-value">87.70%</span>
          </div>
          <div class="metric-labels">
            <span>Tasa de Asistencia</span>
            <span>Nivel Isla</span>
          </div>
          <small>A√±o Acad√©mico: 2023-2024</small>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-icon" style="background: #e74c3c;">
          <i class="bi bi-people"></i>
        </div>
        <div class="metric-content">
          <h6>Matr√≠cula Certificada</h6>
          <p>Matr√≠cula certificada al comienzo del a√±o escolar.</p>
          <div class="metric-values">
            <span class="main-value" id="mMatricula">255</span>
            <span class="secondary-value">213</span>
          </div>
          <div class="metric-labels">
            <span>Matr√≠cula Certificada</span>
            <span>Esperada 2024-2025</span>
          </div>
          <small>A√±o Acad√©mico: 2023-2024</small>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-icon" style="background: var(--brand-400);">
          <i class="bi bi-person-workspace"></i>
        </div>
        <div class="metric-content">
          <h6>Maestros en la Sala de Clase</h6>
          <p>Total de maestros en la escuela.</p>
          <div class="metric-values">
            <span class="main-value" id="mMaestros">20</span>
            <span class="secondary-value">23,998</span>
          </div>
          <div class="metric-labels">
            <span>Maestros en la Sala de Clase</span>
            <span>Nivel Isla</span>
          </div>
          <small>A√±o Acad√©mico: 2023-2024</small>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-icon" style="background: var(--brand-600);">
          <i class="bi bi-arrow-down-circle"></i>
        </div>
        <div class="metric-content">
          <h6>Tasa de Deserci√≥n Anual</h6>
          <p>Promedio de estudiantes que se retir√≥ de la escuela sin transferirse a otra escuela u otro programa aprobado.</p>
          <div class="metric-values">
            <span class="main-value" id="mDesercion">5.47%</span>
            <span class="secondary-value">4.54%</span>
          </div>
          <div class="metric-labels">
            <span>Tasa de Deserci√≥n Anual</span>
            <span>Nivel Isla</span>
          </div>
          <small>A√±o Acad√©mico: 2023-2024</small>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-icon" style="background: #f39c12;">
          <i class="bi bi-currency-dollar"></i>
        </div>
        <div class="metric-content">
          <h6>Inversi√≥n por Estudiante</h6>
          <p>Cantidad invertida por estudiante.</p>
          <div class="metric-values">
            <span class="main-value" id="mInversion">$15,655</span>
            <span class="secondary-value">$14,053</span>
          </div>
          <div class="metric-labels">
            <span>Inversi√≥n por Estudiante</span>
            <span>Nivel Isla</span>
          </div>
          <small>A√±o Acad√©mico: 2022-2023</small>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!-- FIN MODAL ESCUELA -->

  </div>

</div>

<!-- ===== FOOTER ===== -->
        </div>

        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-card-list"></i>
          </div>
          <div class="sd-info-content">
            <h6>C√≥digo</h6>
            <p id="sdCode">‚Äî</p>
          </div>
        </div>
        
        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-building"></i>
          </div>
          <div class="sd-info-content">
            <h6>Municipio</h6>
            <p id="sdMunicipio">‚Äî</p>
          </div>
        </div>

        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-clock"></i>
          </div>
          <div class="sd-info-content">
            <h6>Horario</h6>
            <p id="sdHorario">‚Äî</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n: Detalles Oficiales -->
    <div class="sd-section">
      <div class="sd-section-title">
        <i class="bi bi-card-text"></i>
        Detalles de la Escuela
      </div>
      
      <div class="sd-info-grid">
        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-mortarboard"></i>
          </div>
          <div class="sd-info-content">
            <h6>Nivel Educativo</h6>
            <p id="sdLevel2">PRIMARIO</p>
          </div>
        </div>

        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-123"></i>
          </div>
          <div class="sd-info-content">
            <h6>Grados</h6>
            <p id="sdGrades2">K - 8</p>
          </div>
        </div>

        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-geo"></i>
          </div>
          <div class="sd-info-content">
            <h6>Regi√≥n</h6>
            <p id="sdRegion">ARECIBO</p>
          </div>
        </div>

        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-check-circle"></i>
          </div>
          <div class="sd-info-content">
            <h6>Estado</h6>
            <p id="sdStatusText">Apta para abrir</p>
          </div>
        </div>

        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-calendar-week"></i>
          </div>
          <div class="sd-info-content">
            <h6>Modalidad</h6>
            <p id="sdModalidad2">Horario Regular</p>
          </div>
        </div>

        <div class="sd-info-item">
          <div class="sd-info-icon">
            <i class="bi bi-clock-history"></i>
          </div>
          <div class="sd-info-content">
            <h6>Horario Detallado</h6>
            <p id="sdHorario2">Lunes a viernes 7:30 AM - 2:30 PM</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n: Calificaciones -->
    <div class="sd-section">
      <div class="sd-section-title">
        <i class="bi bi-star-fill"></i>
        Evaluaci√≥n por Categor√≠as
      </div>
      
      <div class="sd-rating-grid">
        <div class="sd-rating-item">
          <div class="sd-rating-label">Logro Acad√©mico</div>
          <div class="sd-stars" id="sdAcad">
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-empty"></i>
            <i class="bi bi-star-fill star-empty"></i>
          </div>
        </div>

        <div class="sd-rating-item">
          <div class="sd-rating-label">Calidad de Ense√±anza</div>
          <div class="sd-stars" id="sdCalidad">
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-empty"></i>
          </div>
        </div>

        <div class="sd-rating-item">
          <div class="sd-rating-label">Administraci√≥n</div>
          <div class="sd-stars" id="sdAdmin">
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
            <i class="bi bi-star-fill star-filled"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n: Proficiencia Acad√©mica -->
    <div class="sd-section">
      <div class="sd-section-title">
        <i class="bi bi-graph-up"></i>
        Niveles de Proficiencia
      </div>
      
      <div class="sd-proficiency-grid">
        <div class="sd-prof-item">
          <div class="sd-prof-header">
            <span class="sd-prof-label">Espa√±ol</span>
            <span class="sd-prof-value" id="p-es">78.50%</span>
          </div>
          <div class="sd-prof-bar">
            <div class="sd-prof-fill" id="f-es" style="width: 78.5%"></div>
            <div class="sd-prof-goal" id="g-es" style="left: 61%"></div>
          </div>
        </div>

        <div class="sd-prof-item">
          <div class="sd-prof-header">
            <span class="sd-prof-label">Matem√°ticas</span>
            <span class="sd-prof-value" id="p-ma">65.20%</span>
          </div>
          <div class="sd-prof-bar">
            <div class="sd-prof-fill" id="f-ma" style="width: 65.2%"></div>
            <div class="sd-prof-goal" id="g-ma" style="left: 49%"></div>
          </div>
        </div>

        <div class="sd-prof-item">
          <div class="sd-prof-header">
            <span class="sd-prof-label">Ingl√©s</span>
            <span class="sd-prof-value" id="p-en">72.10%</span>
          </div>
          <div class="sd-prof-bar">
            <div class="sd-prof-fill" id="f-en" style="width: 72.1%"></div>
            <div class="sd-prof-goal" id="g-en" style="left: 56%"></div>
          </div>
        </div>

        <div class="sd-prof-item">
          <div class="sd-prof-header">
            <span class="sd-prof-label">Ciencias</span>
            <span class="sd-prof-value" id="p-ci">69.80%</span>
          </div>
          <div class="sd-prof-bar">
            <div class="sd-prof-fill" id="f-ci" style="width: 69.8%"></div>
            <div class="sd-prof-goal" id="g-ci" style="left: 52%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n: M√©tricas Clave -->
    <div class="sd-section">
      <div class="sd-section-title">
        <i class="bi bi-bar-chart-fill"></i>
        Indicadores de Rendimiento
      </div>
      
      <div class="sd-metrics-grid">
        <div class="sd-metric-card">
          <div class="sd-metric-icon">
            <i class="bi bi-person-check"></i>
          </div>
          <div class="sd-metric-value" id="m-asistencia">94.5%</div>
          <div class="sd-metric-label">Asistencia</div>
        </div>

        <div class="sd-metric-card">
          <div class="sd-metric-icon">
            <i class="bi bi-people"></i>
          </div>
          <div class="sd-metric-value" id="m-matricula">485</div>
          <div class="sd-metric-label">Matr√≠cula</div>
        </div>

        <div class="sd-metric-card">
          <div class="sd-metric-icon">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
          <div class="sd-metric-value" id="m-matricula-exp">500</div>
          <div class="sd-metric-label">Meta Matr√≠cula</div>
        </div>

        <div class="sd-metric-card">
          <div class="sd-metric-icon">
            <i class="bi bi-person-workspace"></i>
          </div>
          <div class="sd-metric-value" id="m-maestros">28</div>
          <div class="sd-metric-label">Maestros</div>
        </div>

        <div class="sd-metric-card">
          <div class="sd-metric-icon">
            <i class="bi bi-arrow-down-circle"></i>
          </div>
          <div class="sd-metric-value" id="m-desercion">2.1%</div>
          <div class="sd-metric-label">Deserci√≥n</div>
        </div>

        <div class="sd-metric-card">
          <div class="sd-metric-icon">
            <i class="bi bi-currency-dollar"></i>
          </div>
          <div class="sd-metric-value" id="m-inversion">$8,250</div>
          <div class="sd-metric-label">Inversi√≥n por Estudiante</div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n eliminada - el mapa ahora est√° en el header -->

  </div>
</div>
<!-- FIN MODAL ESCUELA -->

  </div>

</div>


                <label>Horario:</label>
                <span id="sdHorario2">Lunes a viernes 8:00AM - 3:00PM</span>
              </div>
            </div>
          </div>
          
          <!-- Bot√≥n Matr√≠cula en L√≠nea -->
          <div class="sd-matricula-section mt-3">
            <div class="matricula-banner">
              <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzAwNkFEQyIvPgo8cGF0aCBkPSJNMTIgMTZIMjhWMjRIMTJWMTZaIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPHBhdGggZD0iTTE2IDEyVjIwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz4KPHN2Zz4K" alt="Matr√≠cula">
              <div>
                <strong>MATR√çCULA EN L√çNEA</strong>
                <p class="mb-0 small">Proceso de matr√≠cula digital del Departamento de Educaci√≥n</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Star Rating -->
    <div class="sd-card mt-4">
      <div class="sd-section-header">
        <div class="d-flex align-items-center gap-2">
          <div class="star-rating-icon">
            <i class="bi bi-award-fill"></i>
          </div>
          <div>
            <h6>Star Rating</h6>
            <p class="sd-section-subtitle mb-0">Desempe√±o de las escuelas en 3 dominios de rendimiento. Las escuelas reciben una calificaci√≥n de 1 a 5 estrellas. <a href="#" class="text-primary">M√°s informaci√≥n</a></p>
          </div>
        </div>
      </div>
      
      <div class="official-rating-grid">
        <div class="rating-column">
          <label>Aprovechamiento Acad√©mico</label>
          <div class="official-stars" id="sdAcad">
            ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
          </div>
        </div>
        
        <div class="rating-column">
          <label>Calidad Escolar</label>
          <div class="official-stars" id="sdCalidad">
            ‚≠ê‚≠ê‚≠ê‚≠ê
          </div>
        </div>
        
        <div class="rating-column">
          <label>Administraci√≥n Escolar</label>
          <div class="official-stars" id="sdAdmin">
            ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
          </div>
        </div>
      </div>
    </div>

    <!-- Proficiencia -->
    <div class="sd-card mt-4">
      <div class="sd-section-header">
        <div class="d-flex align-items-center gap-2">
          <div class="proficiency-icon">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
          <div>
            <h6>Proficiencia</h6>
            <p class="sd-section-subtitle mb-0">Porcentaje de estudiantes con desempe√±o proficiente o avanzado en las pruebas estandarizadas META-PR. <a href="#" class="text-primary">M√°s informaci√≥n</a></p>
            <small class="text-muted">A√±o Acad√©mico: 2023-2024</small>
          </div>
        </div>
      </div>

      <div class="official-proficiency-container">
        <div class="proficiency-subject">
          <div class="subject-header">
            <span class="subject-name">Espa√±ol</span>
            <span class="subject-percentage" id="p-es">82.48%</span>
          </div>
          <div class="progress-bar-official">
            <div class="progress-fill progress-fill-blue" id="f-es" style="width: 82.48%"></div>
            <div class="progress-markers">
              <div class="progress-marker goal-marker" style="left: 80%">
                <span class="marker-icon">üéØ</span>
                <span class="marker-label">Objetivo 80%</span>
              </div>
              <div class="progress-marker avg-marker" style="left: 39.52%">
                <span class="marker-icon">üìä</span>
                <span class="marker-label">Promedio Isla 39.52%</span>
              </div>
            </div>
          </div>
        </div>

        <div class="proficiency-subject">
          <div class="subject-header">
            <span class="subject-name">Matem√°ticas</span>
            <span class="subject-percentage" id="p-ma">84.78%</span>
          </div>
          <div class="progress-bar-official">
            <div class="progress-fill progress-fill-red" id="f-ma" style="width: 84.78%"></div>
            <div class="progress-markers">
              <div class="progress-marker goal-marker" style="left: 73%">
                <span class="marker-icon">üéØ</span>
                <span class="marker-label">73%</span>
              </div>
              <div class="progress-marker avg-marker" style="left: 32.58%">
                <span class="marker-icon">üìä</span>
                <span class="marker-label">32.58%</span>
              </div>
            </div>
          </div>
        </div>

        <div class="proficiency-subject">
          <div class="subject-header">
            <span class="subject-name">Ingl√©s</span>
            <span class="subject-percentage" id="p-en">93.38%</span>
          </div>
          <div class="progress-bar-official">
            <div class="progress-fill progress-fill-green" id="f-en" style="width: 93.38%"></div>
            <div class="progress-markers">
              <div class="progress-marker goal-marker" style="left: 77%">
                <span class="marker-icon">üéØ</span>
                <span class="marker-label">77%</span>
              </div>
              <div class="progress-marker avg-marker" style="left: 30.1%">
                <span class="marker-icon">üìä</span>
                <span class="marker-label">30.1%</span>
              </div>
            </div>
          </div>
        </div>

        <div class="proficiency-subject">
          <div class="subject-header">
            <span class="subject-name">Ciencia</span>
            <span class="subject-percentage" id="p-ci">65.22%</span>
          </div>
          <div class="progress-bar-official">
            <div class="progress-fill progress-fill-blue" id="f-ci" style="width: 65.22%"></div>
            <div class="progress-markers">
              <div class="progress-marker goal-marker" style="left: 50%">
                <span class="marker-icon">üéØ</span>
                <span class="marker-label">50%</span>
              </div>
              <div class="progress-marker avg-marker" style="left: 38.03%">
                <span class="marker-icon">üìä</span>
                <span class="marker-label">38.03%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Indicadores Oficiales -->
    <div class="row g-2 mt-1 metrics-single-row">
      <!-- Tasa de Asistencia -->
      <div class="col">
        <div class="official-metric-card">
          <div class="metric-icon metric-icon-blue">
            <i class="bi bi-people-fill"></i>
          </div>
          <div class="metric-content">
            <h6>Tasa de Asistencia</h6>
            <p class="metric-description">Tasa de asistencia de los estudiantes.</p>
            <div class="metric-values">
              <div class="metric-main">
                <span class="metric-number" id="m-asistencia">86.88%</span>
                <label>Tasa de Asistencia</label>
                <small>A√±o Acad√©mico: 2023-2024</small>
              </div>
              <div class="metric-compare">
                <span class="metric-number">87.70%</span>
                <label>Nivel Isla</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Matr√≠cula Certificada -->
      <div class="col">
        <div class="official-metric-card">
          <div class="metric-icon metric-icon-pink">
            <i class="bi bi-person-check-fill"></i>
          </div>
          <div class="metric-content">
            <h6>Matr√≠cula Certificada</h6>
            <p class="metric-description">Matr√≠cula certificada al comienzo del a√±o escolar.</p>
            <div class="metric-values">
              <div class="metric-main">
                <span class="metric-number" id="m-matricula">182</span>
                <label>Matr√≠cula Certificada</label>
                <small>A√±o Acad√©mico: 2023-2024</small>
              </div>
              <div class="metric-compare">
                <span class="metric-number">169</span>
                <label>Esperada 2024-2025</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Maestros en la Sala de Clase -->
      <div class="col">
        <div class="official-metric-card">
          <div class="metric-icon metric-icon-orange">
            <i class="bi bi-person-workspace"></i>
          </div>
          <div class="metric-content">
            <h6>Maestros en la Sala de Clase</h6>
            <p class="metric-description">Total de maestros en la escuela.</p>
            <div class="metric-values">
              <div class="metric-main">
                <span class="metric-number" id="m-maestros">18</span>
                <label>Maestros en la Sala de Clase</label>
                <small>A√±o Acad√©mico: 2023-2024</small>
              </div>
              <div class="metric-compare">
                <span class="metric-number">23,998</span>
                <label>Nivel Isla</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tasa de Deserci√≥n -->
      <div class="col">
        <div class="official-metric-card">
          <div class="metric-icon metric-icon-teal">
            <i class="bi bi-arrow-repeat"></i>
          </div>
          <div class="metric-content">
            <h6>Tasa de Deserci√≥n Anual</h6>
            <p class="metric-description">Promedio de estudiantes que se retir√≥ de la escuela sin transferirse a otra escuela u otro programa aprobado.</p>
            <div class="metric-values">
              <div class="metric-main">
                <span class="metric-number" id="m-desercion">6.44%</span>
                <label>Tasa de Deserci√≥n Anual</label>
                <small>A√±o Acad√©mico: 2023-2024</small>
              </div>
              <div class="metric-compare">
                <span class="metric-number">4.54%</span>
                <label>Nivel Isla</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Inversi√≥n por Estudiante -->
      <div class="col">
        <div class="official-metric-card">
          <div class="metric-icon metric-icon-yellow">
            <i class="bi bi-cash-stack"></i>
          </div>
          <div class="metric-content">
            <h6>Inversi√≥n por Estudiante</h6>
            <p class="metric-description">Cantidad invertida por estudiante.</p>
            <div class="metric-values">
              <div class="metric-main">
                <span class="metric-number" id="m-inversion">$17,148</span>
                <label>Inversi√≥n por Estudiante</label>
                <small>A√±o Acad√©mico: 2022-2023</small>
              </div>
              <div class="metric-compare">
                <span class="metric-number">$14,053</span>
                <label>Nivel Isla</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>


<!-- ===== FOOTER ===== -->
<footer class="footer py-4 border-top">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
    <span class="text-muted small">¬© <span id="year"></span> SchoolFinder. Todos los derechos reservados.</span>
    <ul class="nav gap-3 small">
      <li class="nav-item"><a class="nav-link px-0 text-muted" href="#">Privacidad</a></li>
      <li class="nav-item"><a class="nav-link px-0 text-muted" href="#">T√©rminos</a></li>
      <li class="nav-item"><a class="nav-link px-0 text-muted" href="#">Soporte</a></li>
    </ul>
  </div>
</footer>

<!-- OFFCANVAS: Comparar Escuelas - Dise√±o Profesional Mejorado -->
<div class="offcanvas offcanvas-end comparison-modal" tabindex="-1" id="compareOffcanvas" aria-labelledby="compareOffcanvasLabel">
  <!-- Header Profesional con Gradiente y Estad√≠sticas -->
  <div class="comparison-header">
    <div class="header-background"></div>
    <div class="header-content">
      <div class="header-main">
        <div class="header-icon">
          <i class="bi bi-graph-up-arrow"></i>
        </div>
        <div class="header-text">
          <h3 class="modal-title" id="compareOffcanvasLabel">
            Comparaci√≥n Avanzada
          </h3>
          <p class="modal-subtitle">
            An√°lisis detallado de escuelas seleccionadas
          </p>
        </div>
      </div>
      <button type="button" class="btn-close-custom" data-bs-dismiss="offcanvas" aria-label="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <!-- Barra de estad√≠sticas en tiempo real -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-icon">
          <i class="bi bi-building"></i>
        </div>
        <div class="stat-content">
          <span class="stat-number" id="compareCount">0</span>
          <span class="stat-label">Escuelas</span>
        </div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="bi bi-star-fill"></i>
        </div>
        <div class="stat-content">
          <span class="stat-number" id="avgRating">--</span>
          <span class="stat-label">Promedio</span>
        </div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <div class="stat-icon">
          <i class="bi bi-geo-alt"></i>
        </div>
        <div class="stat-content">
          <span class="stat-number" id="municipiosCount">--</span>
          <span class="stat-label">Municipios</span>
        </div>
      </div>
      
      <div class="stats-actions">
        <button type="button" class="btn-clear-all" id="clearComparisonBtn">
          <i class="bi bi-trash3"></i>
          <span>Limpiar todo</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Contenido Principal con Navegaci√≥n por Tabs -->
  <div class="offcanvas-body comparison-body">
    <!-- Navegaci√≥n por pesta√±as -->
    <div class="comparison-tabs">
      <nav class="tab-navigation">
        <button class="tab-btn active" data-tab="overview">
          <i class="bi bi-grid-3x3-gap"></i>
          <span>Vista General</span>
        </button>
        <button class="tab-btn" data-tab="academics">
          <i class="bi bi-mortarboard"></i>
          <span>Acad√©mico</span>
        </button>
        <button class="tab-btn" data-tab="details">
          <i class="bi bi-list-check"></i>
          <span>Detalles</span>
        </button>
      </nav>
    </div>
    
    <!-- Contenido de las pesta√±as -->
    <div class="tab-content">
      <!-- Tab 1: Vista General -->
      <div class="tab-panel active" id="tab-overview">
        <div class="section-header">
          <h5>Comparaci√≥n General</h5>
          <p>Vista r√°pida de las diferencias principales</p>
        </div>
        
        <!-- Comparaci√≥n lado a lado -->
        <div class="side-by-side-comparison" id="overviewComparison">
          <!-- Las tarjetas de escuelas se generar√°n din√°micamente aqu√≠ -->
        </div>
        
        <!-- Resumen comparativo -->
        <div class="comparison-summary">
          <div class="summary-card">
            <div class="summary-icon">
              <i class="bi bi-star"></i>
            </div>
            <div class="summary-content">
              <h6>Mejor Calificada</h6>
              <span id="bestRated">‚Äî</span>
            </div>
          </div>
          
          <div class="summary-card">
            <div class="summary-icon">
              <i class="bi bi-geo-alt"></i>
            </div>
            <div class="summary-content">
              <h6>M√°s Cercana</h6>
              <span id="closest">‚Äî</span>
            </div>
          </div>
          
          <div class="summary-card">
            <div class="summary-icon">
              <i class="bi bi-people"></i>
            </div>
            <div class="summary-content">
              <h6>M√°s Estudiantes</h6>
              <span id="largest">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab 2: Comparaci√≥n Acad√©mica -->
      <div class="tab-panel" id="tab-academics">
        <div class="section-header">
          <h5>Comparaci√≥n Acad√©mica</h5>
          <p>Rendimiento educativo lado a lado</p>
        </div>
        
        <!-- Comparaci√≥n acad√©mica visual -->
        <div class="academic-visual-comparison">
          <div class="academic-comparison-grid" id="academicGrid">
            <!-- Grid de comparaci√≥n acad√©mica se generar√° din√°micamente -->
          </div>
          
          <!-- M√©tricas clave comparativas -->
          <div class="key-metrics">
            <h6 class="metrics-title">M√©tricas Clave</h6>
            <div class="metrics-comparison-row">
              <div class="metric-label">Calificaci√≥n General</div>
              <div class="metric-bars" id="ratingBars">
                <!-- Barras de calificaci√≥n se generar√°n din√°micamente -->
              </div>
            </div>
            
            <div class="metrics-comparison-row">
              <div class="metric-label">Proficiencia Promedio</div>
              <div class="metric-bars" id="levelBars">
                <!-- Barras de nivel se generar√°n din√°micamente -->
              </div>
            </div>
            
            <div class="metrics-comparison-row">
              <div class="metric-label">Matr√≠cula Estudiantil</div>
              <div class="metric-bars" id="programBars">
                <!-- Barras de programas se generar√°n din√°micamente -->
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab 3: Detalles Comparativos -->
      <div class="tab-panel" id="tab-details">
        <div class="section-header">
          <h5>Detalles Lado a Lado</h5>
          <p>Comparaci√≥n detallada de caracter√≠sticas</p>
        </div>
        
        <!-- Tabla de comparaci√≥n simple y limpia -->
        <div class="clean-comparison-table">
          <div class="comparison-features" id="featuresComparison">
            <!-- Filas de comparaci√≥n se generar√°n din√°micamente -->
          </div>
        </div>
        
        <!-- Servicios disponibles - Comparaci√≥n visual -->
        <div class="services-visual-comparison">
          <h6 class="services-header">
            <i class="bi bi-check2-square"></i>
            Servicios Disponibles
          </h6>
          <div class="services-comparison-grid" id="servicesComparisonGrid">
            <!-- Grid de servicios se generar√° din√°micamente -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Direcciones y Rutas -->
<div class="modal fade" id="directionsModal" tabindex="-1" aria-labelledby="directionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex align-items-center gap-3">
          <div class="directions-school-avatar">
            <i class="bi bi-building"></i>
          </div>
          <div>
            <h5 class="modal-title" id="directionsModalLabel">C√≥mo llegar</h5>
            <p class="directions-school-name mb-0 text-muted"></p>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      
      <div class="modal-body">
        <!-- Opciones de transporte -->
        <div class="transport-options mb-4">
          <h6 class="mb-3"><i class="bi bi-compass"></i> Opciones de Transporte</h6>
          <div class="btn-group w-100" role="group" aria-label="Opciones de transporte">
            <input type="radio" class="btn-check" name="transportMode" id="driving" value="driving" checked>
            <label class="btn btn-outline-primary transport-btn" for="driving">
              <i class="bi bi-car-front"></i>
              <span>Auto</span>
            </label>
            
            <input type="radio" class="btn-check" name="transportMode" id="transit" value="transit">
            <label class="btn btn-outline-primary transport-btn" for="transit">
              <i class="bi bi-bus-front"></i>
              <span>Transporte</span>
            </label>
            
            <input type="radio" class="btn-check" name="transportMode" id="walking" value="walking">
            <label class="btn btn-outline-primary transport-btn" for="walking">
              <i class="bi bi-person-walking"></i>
              <span>Caminando</span>
            </label>
          </div>
        </div>
        
        <!-- Informaci√≥n de ruta -->
        <div class="route-info">
          <div class="row">
            <div class="col-md-6">
              <div class="route-summary">
                <h6><i class="bi bi-clock"></i> Resumen del Viaje</h6>
                <div class="route-details">
                  <div class="route-detail-item">
                    <span class="route-label">Distancia:</span>
                    <span class="route-value" id="routeDistance">Calculando...</span>
                  </div>
                  <div class="route-detail-item">
                    <span class="route-label">Tiempo estimado:</span>
                    <span class="route-value" id="routeTime">Calculando...</span>
                  </div>
                  <div class="route-detail-item">
                    <span class="route-label">Condiciones actuales:</span>
                    <span class="route-value" id="trafficConditions">
                      <span class="traffic-light normal"></span>
                      Tr√°fico normal
                    </span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="traffic-info">
                <h6><i class="bi bi-graph-up"></i> Horarios de Mayor Tr√°fico</h6>
                <div class="traffic-schedule">
                  <div class="traffic-time-item">
                    <span class="traffic-time">7:00 - 9:00 AM</span>
                    <div class="traffic-bar">
                      <div class="traffic-level heavy" style="width: 85%"></div>
                    </div>
                    <span class="traffic-label">Pesado</span>
                  </div>
                  <div class="traffic-time-item">
                    <span class="traffic-time">12:00 - 1:00 PM</span>
                    <div class="traffic-bar">
                      <div class="traffic-level moderate" style="width: 60%"></div>
                    </div>
                    <span class="traffic-label">Moderado</span>
                  </div>
                  <div class="traffic-time-item">
                    <span class="traffic-time">4:00 - 6:00 PM</span>
                    <div class="traffic-bar">
                      <div class="traffic-level heavy" style="width: 90%"></div>
                    </div>
                    <span class="traffic-label">Pesado</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Mapa de ruta -->
        <div class="route-map-container mt-4">
          <h6><i class="bi bi-map"></i> Mapa de Ruta</h6>
          <div id="routeMap" class="route-map">
            <!-- El mapa se cargar√° aqu√≠ -->
          </div>
        </div>
        
        <!-- Instrucciones paso a paso -->
        <div class="route-instructions mt-4">
          <h6><i class="bi bi-list-ol"></i> Instrucciones</h6>
          <div id="stepByStepInstructions" class="instructions-list">
            <!-- Las instrucciones se cargar√°n din√°micamente -->
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="openExternalMap">
          <i class="bi bi-box-arrow-up-right"></i>
          Abrir en Google Maps
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===== JS ===== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== util ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
document.getElementById('year').textContent = new Date().getFullYear();

/* ===== rating estrellas ===== */
function paintStars(wrap, rating){
  const full = Math.floor(rating), half = rating - full >= 0.5;
  let html='';
  for(let i=0;i<full;i++) html+='<i class="bi bi-star-fill"></i>';
  if(half) html+='<i class="bi bi-star-half"></i>';
  for(let i=full+(half?1:0); i<5; i++) html+='<i class="bi bi-star"></i>';
  wrap.innerHTML = html;
}

/* ===== Sistema de geolocalizaci√≥n y distancias ===== */
let userLocation = null;

// Obtener ubicaci√≥n del usuario
function getUserLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error('Geolocalizaci√≥n no soportada'));
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      position => {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        resolve(userLocation);
      },
      error => {
        console.warn('Error obteniendo ubicaci√≥n:', error);
        // Si no se puede obtener la ubicaci√≥n, usar San Juan como referencia
        userLocation = { lat: 18.4655, lng: -66.1057 };
        resolve(userLocation);
      },
      { timeout: 10000, enableHighAccuracy: true }
    );
  });
}

// Calcular distancia usando f√≥rmula Haversine
function calculateDistance(lat1, lng1, lat2, lng2) {
  const R = 3959; // Radio de la Tierra en millas
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng/2) * Math.sin(dLng/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Formatear distancia
function formatDistance(miles) {
  if (miles < 0.1) return '< 0.1 mi';
  if (miles < 1) return miles.toFixed(1) + ' mi';
  return miles.toFixed(1) + ' mi';
}

// Funci√≥n espec√≠fica para mostrar distancias en tarjetas
function forceShowDistances() {
  console.log('üéØ Forzando mostrar distancias en todas las tarjetas...');
  
  // Obtener todas las tarjetas de escuelas
  const cards = document.querySelectorAll('.sf-card');
  console.log('üìã Encontradas', cards.length, 'tarjetas');
  
  cards.forEach((card, index) => {
    const distanceInfo = card.querySelector('.distance-info');
    if (distanceInfo) {
      // Forzar mostrar el elemento
      distanceInfo.classList.remove('d-none');
      distanceInfo.style.display = 'inline-flex';
      
      const distanceText = distanceInfo.querySelector('.distance');
      if (distanceText && (!distanceText.textContent || distanceText.textContent.trim() === '')) {
        // Si no tiene texto, ponerle una distancia de ejemplo
        distanceText.textContent = (Math.random() * 10 + 1).toFixed(1) + ' mi';
      }
      
      console.log('‚úÖ Tarjeta', index + 1, '- Distancia mostrada:', distanceText ? distanceText.textContent : 'sin texto');
    } else {
      console.log('‚ùå Tarjeta', index + 1, '- No tiene elemento .distance-info');
    }
  });
}

// Funci√≥n de utilidad para debug - forzar actualizaci√≥n manual
window.forceUpdateDistances = function() {
  console.log('üîß Forzando actualizaci√≥n manual de distancias...');
  if (!userLocation) {
    console.log('‚ùå Primero obteniendo ubicaci√≥n...');
    getUserLocation().then(() => {
      updateDistancesInExistingCards();
      forceShowDistances();
    });
  } else {
    updateDistancesInExistingCards();
    forceShowDistances();
  }
};

// Funci√≥n para mostrar distancias sin ubicaci√≥n (modo debug)
window.forceShowDistances = forceShowDistances;

// Funci√≥n para probar filtro de distancia manualmente
window.testDistanceFilter = function(miles = 10) {
  console.log('üß™ Probando filtro de distancia con', miles, 'millas');
  setDistanceFilter(miles);
};

// Funci√≥n para resetear filtro de distancia
window.resetDistanceFilter = function() {
  console.log('üîÑ Reseteando filtro de distancia');
  setDistanceFilter(50);
};

/* ===== Sistema de colores coordinado con index.html ===== */
function getSchoolTypeFromNiveles(niveles) {
  // Mapea niveles educativos a tipos de escuela para colores coordinados
  if (niveles.includes('K‚Äì5') || niveles.includes('Inicial')) return 'Elemental';
  if (niveles.includes('6‚Äì8')) return 'Intermedia';
  if (niveles.includes('9‚Äì12')) return 'Superior';
  if (niveles.includes('K‚Äì12')) return 'K-12';
  return null;
}

function getMarkerColorForSchoolType(type) {
  // Colores coordinados con el mapa del index.html
  const colorMap = {
    'Elemental': '#059669',    // Verde esmeralda
    'Intermedia': '#dc2626',   // Rojo
    'Superior': '#7c3aed',     // Morado
    'K-12': '#ea580c'          // Naranja
  };
  return colorMap[type] || '#6b7280';
}

/* ===== demo data generator (reemplaza por tu API) ===== */
const SCHOOLS_TOTAL = 845;
const PAGE_SIZE = 20;
const center = {lat: 18.2208, lng: -66.4512}; // Centro de Puerto Rico

// Variable global para almacenar todas las escuelas cargadas
let allSchoolsLoaded = [];

const municipiosDemo = ["San Juan","Bayam√≥n","Carolina","Ponce","Caguas","Guaynabo","Mayag√ºez","Arecibo","Fajardo","Humacao"];
const especialidades = ["Ciencias","Artes","Deportes","Tecnolog√≠a","Idiomas","STEAM"];
const nivelesOpts = ["Inicial","K‚Äì5","6‚Äì8","9‚Äì12","K‚Äì12","EEE ¬∑ EEI"];
const generoOpts = ["Mixto","Solo mujeres","Solo varones"];
const idiomaOpts = ["Biling√ºe","Espa√±ol","Ingl√©s"];
const modalidadOpts = ["Regular","Extendido","Nocturno"];

function rand(min,max){ return Math.random()*(max-min)+min }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

// Datos reales de escuelas con informaci√≥n acad√©mica
const realSchoolsData = [
  {
    id: 1,
    name: "Ismael Maldonado Lugaro",
    type: "P√∫blico",
    level: "Elemental",
    gender: "Mixto",
    language: "Espa√±ol",
    rating: 4.2,
    stars: "‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ",
    location: "Arecibo",
    coordinates: { lat: 18.4738, lng: -66.7320 },
    address: "CARR 638 HM 5 BO MIRAFLORES ARECIBO PR, 00612",
    phone: "(787) 878-3456",
    email: "ismael.maldonado@de.pr.gov",
    proficiency: {
      espanol: 82.48,
      matematicas: 84.78,
      ingles: 93.38,
      ciencias: 65.22
    },
    metrics: {
      matriculaCertificada: 182,
      tasaDesercion: 6.44,
      tasaAsistencia: 86.88,
      inversionPorEstudiante: 17148,
      totalMaestros: 18
    }
  },
  {
    id: 2,
    name: "Intermedia Coqui",
    type: "P√∫blico", 
    level: "Intermedia",
    gender: "Mixto",
    language: "Espa√±ol",
    rating: 4.1,
    stars: "‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ",
    location: "Bayam√≥n",
    coordinates: { lat: 18.3894, lng: -66.1582 },
    address: "Ave. Luis Mu√±oz Rivera #123, Bayam√≥n PR, 00961",
    phone: "(787) 785-2341",
    email: "intermedia.coqui@de.pr.gov",
    proficiency: {
      espanol: 65.0,
      matematicas: 85.83,
      ingles: 83.9,
      ciencias: 59.09
    },
    metrics: {
      matriculaCertificada: 248,
      tasaDesercion: 0.73,
      tasaAsistencia: 84.48,
      inversionPorEstudiante: 15202,
      totalMaestros: 23
    }
  }
];

function fakeSchool(i){
  const rating = +(rand(3.5,5).toFixed(1));
  const opiniones = Math.floor(rand(15, 400));
  const muni = pick(municipiosDemo);
  
  // Coordenadas m√°s realistas para Puerto Rico
  // PR est√° entre lat: 17.88-18.52 y lng: -67.27--65.22
  const lat = rand(17.95, 18.48);
  const lng = rand(-67.20, -65.30);
  
  const tipo = Math.random() < 0.55 ? "P√∫blico" : "Privado";
  return {
    id: String(i+1),
    nombre: (Math.random()<0.5?'Colegio ':'Escuela ') + ['San Mart√≠n','Los √Ångeles','Nueva Esperanza','Santa Mar√≠a','Innovaci√≥n','Horizontes'][i%6],
    codigo: String(10000 + i),
    municipio: muni,
    rating, opiniones,
    horario: "8:00 AM ‚Äì 3:00 PM",
    modalidad: pick(modalidadOpts),
    niveles: pick(nivelesOpts),
    especialidad: pick(especialidades),
    genero: pick(generoOpts),
    idioma: pick(idiomaOpts),
    tipo,
    estado: Math.random()<0.9 ? "ok" : "warn",
    href: "profile.html?id="+(i+1),
    logo: "https://placehold.co/80/png",
    lat, lng
  };
}

/* === Punto de integraci√≥n con API ===
async function fetchSchools(page, pageSize, filters){
  const qs = new URLSearchParams({page, pageSize, ...filters}).toString();
  const res = await fetch('/api/schools?'+qs);
  if(!res.ok) throw new Error('API');
  return await res.json(); // {items:[], total:1234}
}
*/
function fetchSchoolsDemo(page, pageSize){
  const start = page * pageSize;
  const end = Math.min(start + pageSize, SCHOOLS_TOTAL);
  const items = [];
  for(let i=start;i<end;i++) items.push(fakeSchool(i));
  return Promise.resolve({items, total: SCHOOLS_TOTAL});
}

/* ===== render tarjeta ===== */
const tpl = $('#cardTemplate');
function cardFromData(s){
  const node = tpl.content.firstElementChild.cloneNode(true);
  node.dataset.id = s.id;
  node.dataset.rating = s.rating;
  node.dataset.lat = s.lat; 
  node.dataset.lng = s.lng;

  // Debug para verificar coordenadas
  console.log('üóÇÔ∏è Creando tarjeta para:', s.nombre || s.name, 'con coordenadas:', s.lat, s.lng);

  node.querySelector('.sf-logo').src = s.logo;
  const title = node.querySelector('.sf-title');
  title.textContent = s.nombre;
  title.href = s.href;

  node.querySelector('.rate-text').textContent = `${s.rating} ¬∑ ${s.opiniones}`;
  paintStars(node.querySelector('.pill-rating .stars'), s.rating);

  node.querySelectorAll('.municipio').forEach(e=> e.textContent = s.municipio);
  node.querySelector('.codigo').textContent = s.codigo;
  node.querySelector('.horario').textContent = s.horario;
  node.querySelector('.modalidad').textContent = s.modalidad;
  node.querySelector('.niveles').textContent = s.niveles;
  node.querySelector('.especialidad').textContent = s.especialidad;

  // Calcular y mostrar distancia si tenemos la ubicaci√≥n del usuario
  if (userLocation && s.lat && s.lng) {
    const distance = calculateDistance(userLocation.lat, userLocation.lng, s.lat, s.lng);
    const distanceElement = node.querySelector('.distance-info');
    const distanceText = node.querySelector('.distance');
    
    if (distanceElement && distanceText) {
      distanceText.textContent = formatDistance(distance);
      distanceElement.classList.remove('d-none');
      console.log('‚úÖ Distancia calculada inmediatamente:', distance.toFixed(2), 'mi para', s.nombre);
      console.log('‚úÖ Elemento distancia:', distanceElement, 'Texto:', distanceText.textContent);
    } else {
      console.log('‚ùå No se encontraron elementos de distancia para:', s.nombre);
    }
  } else {
    console.log('‚ö†Ô∏è Sin ubicaci√≥n del usuario o coordenadas de escuela para:', s.nombre);
    console.log('   - userLocation:', userLocation);
    console.log('   - s.lat:', s.lat, 's.lng:', s.lng);
  }

  // Aplicar colores coordinados para tipos de escuela (del index.html)
  const tipoElement = node.querySelector('.tipo');
  const tipoIcon = s.tipo==='Privado'?'bi-shield-lock':'bi-bank';
  tipoElement.innerHTML = `<i class="bi ${tipoIcon}"></i> ${s.tipo}`;
  
  // Si hay informaci√≥n de nivel educativo, aplicar colores coordinados
  if (s.niveles) {
    const schoolType = getSchoolTypeFromNiveles(s.niveles);
    if (schoolType) {
      tipoElement.setAttribute('data-type', schoolType);
      tipoElement.classList.add(`school-type-${schoolType.toLowerCase()}`);
    }
  }
  
  node.querySelector('.genero').innerHTML = `<i class="bi ${s.genero==='Solo mujeres'?'bi-gender-female':s.genero==='Solo varones'?'bi-gender-male':'bi-gender-ambiguous'}"></i> ${s.genero}`;
  node.querySelector('.idioma').innerHTML = `<i class="bi bi-translate"></i> ${s.idioma}`;
  
  // Actualizar el bot√≥n Ver Perfil (ahora es un button, no un enlace)
  const profileBtn = node.querySelector('.sf-btn-profile');
  if (profileBtn) {
    profileBtn.setAttribute('data-id', s.id);
    profileBtn.setAttribute('data-href', s.href);
  }

  // Actualizar el bot√≥n C√≥mo llegar
  const directionsBtn = node.querySelector('.sf-btn-directions');
  if (directionsBtn) {
    directionsBtn.setAttribute('data-id', s.id);
  }

  node.querySelector('.badge-state.' + (s.estado==='ok'?'ok':'warn')).classList.remove('d-none');
  return node;
}

/* ===== estado y paginaci√≥n infinita ===== */
let page = 0;
let loading = false;
let loaded = 0;
let total = SCHOOLS_TOTAL;

const resultsList = $('#resultsList');
const skeletons = $('#skeletons');
const loadMoreBtn = $('#loadMore');

async function loadNextPage(){
  if(loading) return;
  if(loaded >= total) return;
  loading = true;
  skeletons.classList.remove('d-none');

  // Reemplaza por fetchSchools(page,PAGE_SIZE, currentFilters)
  const {items, total: t} = await fetchSchoolsDemo(page, PAGE_SIZE);
  total = t;

  // Almacenar las escuelas en la variable global
  allSchoolsLoaded.push(...items);

  // Aplicar filtros de distancia a las nuevas escuelas
  let filteredItems = items;
  const distanceSlider = document.getElementById('distanceRange');
  const currentDistance = distanceSlider ? parseInt(distanceSlider.value) : 50;
  
  if (currentDistance < 50 && userLocation) {
    filteredItems = items.filter(school => {
      const distance = calculateDistance(
        userLocation.lat, userLocation.lng,
        school.lat, school.lng
      );
      return distance <= currentDistance;
    });
  }

  const frag = document.createDocumentFragment();
  filteredItems.forEach(s => frag.appendChild(cardFromData(s)));
  resultsList.appendChild(frag);

  loaded += filteredItems.length;
  page += 1;
  skeletons.classList.add('d-none');
  loading = false;

  // Forzar mostrar distancias despu√©s de cargar tarjetas
  setTimeout(() => {
    forceShowDistances();
  }, 500);

  // init acciones nuevas tarjetas
  initSavesForNewCards();
  if(map) renderMarkers(); // sync mapa
  if(loaded >= total){ loadMoreBtn.classList.add('d-none'); observer?.disconnect(); }
}

loadMoreBtn.addEventListener('click', loadNextPage);

/* IntersectionObserver para infinite scroll */
const sentinel = $('#ioSentinel');
const observer = new IntersectionObserver((entries)=>{
  for(const e of entries){
    if(e.isIntersecting){ loadNextPage(); }
  }
},{rootMargin:'600px 0px'});

/* ===== Guardados ===== */
const STORAGE_KEY = 'sf_saved';
const savedCount = $('#savedCount');
const compareBtn = $('#compareBtn');
function getSaved(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ return []; } }

// Funci√≥n para obtener las escuelas guardadas con datos completos
function getSavedSchools() {
  const savedIds = getSaved();
  console.log('üìã IDs guardados:', savedIds);
  
  // Si no hay escuelas guardadas, devolver las dos escuelas reales para demo
  if (savedIds.length === 0) {
    console.log('üéØ No hay escuelas guardadas, usando datos de demo');
    return realSchoolsData;
  }
  
  // Convertir IDs a objetos de escuela
  const schools = savedIds.map(id => {
    // Primero buscar en datos reales
    const realSchool = realSchoolsData.find(school => school.id === parseInt(id));
    if (realSchool) {
      console.log('‚úÖ Encontrada escuela real:', realSchool.name);
      return realSchool;
    }
    
    // Si no est√° en datos reales, crear con datos simulados
    const fakeData = fakeSchool(parseInt(id) - 1);
    console.log('üé≤ Creando datos simulados para ID:', id);
    return {
      id: parseInt(id),
      name: fakeData.nombre,
      type: fakeData.tipo,
      level: fakeData.niveles,
      gender: fakeData.genero,
      language: fakeData.idioma,
      rating: fakeData.rating,
      stars: "‚òÖ".repeat(Math.floor(fakeData.rating)) + (fakeData.rating % 1 >= 0.5 ? "‚òÜ" : ""),
      location: fakeData.municipio,
      address: 'Direcci√≥n no disponible',
      phone: '(787) 000-0000',
      email: 'info@escuela.pr.gov',
      proficiency: {
        espanol: Math.random() * 30 + 60,
        matematicas: Math.random() * 30 + 60,
        ingles: Math.random() * 30 + 60,
        ciencias: Math.random() * 30 + 60
      },
      metrics: {
        matriculaCertificada: Math.floor(Math.random() * 200 + 100),
        tasaDesercion: Math.random() * 10 + 1,
        tasaAsistencia: Math.random() * 20 + 75,
        inversionPorEstudiante: Math.floor(Math.random() * 10000 + 10000),
        totalMaestros: Math.floor(Math.random() * 20 + 10)
      }
    };
  }).filter(Boolean);
  
  console.log('üìö Escuelas obtenidas:', schools.length);
  return schools;
}
function setSaved(arr){ 
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); 
  savedCount.textContent = arr.length;
  // Mostrar bot√≥n de comparar si hay al menos 2 escuelas guardadas
  if(arr.length >= 2) {
    compareBtn.style.display = 'inline-block';
  } else {
    compareBtn.style.display = 'none';
  }
}
setSaved(getSaved());

/* ===== Sistema de Comparaci√≥n Mejorado ===== */
function generateComparisonContent() {
  // Usar directamente la funci√≥n getSavedSchools que maneja datos reales
  const schoolsToCompare = getSavedSchools();
  const overviewComparison = $('#overviewComparison');
  
  console.log('üîÑ Generando contenido de comparaci√≥n para', schoolsToCompare.length, 'escuelas');
  
  // Actualizar estad√≠sticas en el header
  updateComparisonStats(schoolsToCompare.map(s => String(s.id)));
  
  if(schoolsToCompare.length === 0) {
    overviewComparison.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-bookmark"></i>
        <h4>No hay escuelas guardadas</h4>
        <p>Guarda al menos 2 escuelas para poder compararlas y ver an√°lisis detallados</p>
      </div>
    `;
    return;
  }
  
  if(schoolsToCompare.length === 1) {
    overviewComparison.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-arrow-left-right"></i>
        <h4>Necesitas m√°s escuelas</h4>
        <p>Guarda al menos una escuela m√°s para poder compararlas lado a lado</p>
      </div>
    `;
    return;
  }

  // Generar HTML de comparaci√≥n lado a lado
  overviewComparison.innerHTML = schoolsToCompare.map((school, index) => `
    <div class="school-comparison-card ${index === 0 ? 'winner' : ''}">
      <div class="comparison-school-header">
        <div class="comparison-school-avatar">
          ${school.name.charAt(0).toUpperCase()}
        </div>
        <div class="comparison-school-info">
          <h6>${school.name}</h6>
          <div class="comparison-school-location">
            <i class="bi bi-geo-alt"></i>
            ${school.location}
          </div>
        </div>
        <button class="remove-from-comparison" data-id="${school.id}" title="Remover de comparaci√≥n">
          <i class="bi bi-x"></i>
        </button>
      </div>
      
      <div class="comparison-quick-stats">
        <div class="quick-stat">
          <span class="quick-stat-value">${school.rating}</span>
          <span class="quick-stat-label">Rating</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value">${school.metrics.matriculaCertificada}</span>
          <span class="quick-stat-label">Estudiantes</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value">${school.metrics.totalMaestros}</span>
          <span class="quick-stat-label">Maestros</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value">${school.stars}</span>
          <span class="quick-stat-label">Estrellas</span>
        </div>
      </div>
      
      <div class="comparison-highlights">
        <span class="highlight-badge">${school.type}</span>
        <span class="highlight-badge">${school.gender}</span>
        <span class="highlight-badge">${school.language}</span>
      </div>
    </div>
  `).join('');

  // Actualizar resumen comparativo
  updateComparisonSummary(schoolsToCompare);
  
  // Generar contenido acad√©mico
  generateAcademicComparison(schoolsToCompare);
  
  // Generar tabla de detalles
  generateDetailsComparison(schoolsToCompare);
  
  // Agregar event listeners para remover escuelas
  $$('.remove-from-comparison').forEach(btn => {
    btn.addEventListener('click', function() {
      const schoolId = this.dataset.id;
      removeSaved(schoolId);
      generateComparisonContent();
    });
  });
}

// Funci√≥n para actualizar resumen comparativo
function updateComparisonSummary(schools) {
  const bestRated = schools.reduce((max, school) => 
    parseFloat(school.rating) > parseFloat(max.rating) ? school : max
  );
  
  $('#bestRated').textContent = bestRated.name;
  $('#closest').textContent = schools[0].name; // Simplificado por ahora
  $('#largest').textContent = schools[0].name; // Simplificado por ahora
}

// Funci√≥n para generar comparaci√≥n acad√©mica
function generateAcademicComparison(schools) {
  console.log('üéì Generando comparaci√≥n acad√©mica para', schools.length, 'escuelas');
  const academicGrid = $('#academicGrid');
  
  if(!academicGrid) {
    console.error('‚ùå No se encontr√≥ elemento academicGrid');
    return;
  }
  
  academicGrid.innerHTML = schools.map(school => `
    <div class="academic-card">
      <div class="academic-card-header">
        <div class="school-avatar">${school.name.charAt(0).toUpperCase()}</div>
        <div class="school-basic-info">
          <h6>${school.name}</h6>
          <span class="school-type">${school.type}</span>
        </div>
      </div>
      
      <div class="academic-metrics-list">
        <div class="academic-metric">
          <div class="metric-icon excellence-icon">
            <i class="bi bi-book"></i>
          </div>
          <div class="metric-info">
            <span class="metric-name">Proficiencia Espa√±ol</span>
            <div class="metric-bar-container">
              <div class="metric-bar">
                <div class="metric-bar-fill" style="width: ${school.proficiency.espanol}%"></div>
              </div>
              <span class="metric-value">${school.proficiency.espanol.toFixed(1)}%</span>
            </div>
          </div>
        </div>
        
        <div class="academic-metric">
          <div class="metric-icon performance-icon">
            <i class="bi bi-calculator"></i>
          </div>
          <div class="metric-info">
            <span class="metric-name">Proficiencia Matem√°ticas</span>
            <div class="metric-bar-container">
              <div class="metric-bar">
                <div class="metric-bar-fill" style="width: ${school.proficiency.matematicas}%"></div>
              </div>
              <span class="metric-value">${school.proficiency.matematicas.toFixed(1)}%</span>
            </div>
          </div>
        </div>
        
        <div class="academic-metric">
          <div class="metric-icon programs-icon">
            <i class="bi bi-translate"></i>
          </div>
          <div class="metric-info">
            <span class="metric-name">Proficiencia Ingl√©s</span>
            <div class="metric-bar-container">
              <div class="metric-bar">
                <div class="metric-bar-fill" style="width: ${school.proficiency.ingles}%"></div>
              </div>
              <span class="metric-value">${school.proficiency.ingles.toFixed(1)}%</span>
            </div>
          </div>
        </div>
        
        <div class="academic-metric">
          <div class="metric-icon facilities-icon">
            <i class="bi bi-flask"></i>
          </div>
          <div class="metric-info">
            <span class="metric-name">Proficiencia Ciencias</span>
            <div class="metric-bar-container">
              <div class="metric-bar">
                <div class="metric-bar-fill" style="width: ${school.proficiency.ciencias}%"></div>
              </div>
              <span class="metric-value">${school.proficiency.ciencias.toFixed(1)}%</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="academic-highlights">
        <div class="highlight-item">
          <i class="bi bi-check-circle text-success"></i>
          <span>Acreditaci√≥n vigente</span>
        </div>
        <div class="highlight-item">
          <i class="bi bi-award text-warning"></i>
          <span>Programas especiales</span>
        </div>
        <div class="highlight-item">
          <i class="bi bi-people text-primary"></i>
          <span>Ratio 1:${Math.floor(Math.random() * 20) + 10}</span>
        </div>
      </div>
    </div>
  `).join('');
  
  // Generar comparaci√≥n de m√©tricas clave
  generateKeyMetricsComparison(schools);
}

// Funci√≥n para generar m√©tricas clave comparativas
function generateKeyMetricsComparison(schools) {
  // Generar barras de calificaci√≥n general
  const ratingBars = $('#ratingBars');
  if (ratingBars) {
    ratingBars.innerHTML = schools.map(school => {
      const rating = parseFloat(school.rating) || 0;
      const percentage = (rating / 5) * 100;
      
      return `
        <div class="comparison-metric-row">
          <div class="school-name-label">${school.name.substring(0, 20)}${school.name.length > 20 ? '...' : ''}</div>
          <div class="metric-bar-wrapper">
            <div class="metric-progress-bar">
              <div class="metric-progress-fill rating-fill" style="width: ${percentage}%"></div>
            </div>
            <span class="metric-result">${rating}/5</span>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // Generar barras de proficiencia promedio
  const levelBars = $('#levelBars');
  if (levelBars) {
    levelBars.innerHTML = schools.map(school => {
      // Calcular promedio de proficiencia
      const avgProficiency = (
        school.proficiency.espanol + 
        school.proficiency.matematicas + 
        school.proficiency.ingles + 
        school.proficiency.ciencias
      ) / 4;
      
      return `
        <div class="comparison-metric-row">
          <div class="school-name-label">${school.name.substring(0, 20)}${school.name.length > 20 ? '...' : ''}</div>
          <div class="metric-bar-wrapper">
            <div class="metric-progress-bar">
              <div class="metric-progress-fill level-fill" style="width: ${avgProficiency}%"></div>
            </div>
            <span class="metric-result">${avgProficiency.toFixed(1)}%</span>
          </div>
        </div>
      `;
    }).join('');
  }
  
  // Generar barras de matr√≠cula estudiantil
  const programBars = $('#programBars');
  if (programBars) {
    programBars.innerHTML = schools.map(school => {
      const matricula = school.metrics.matriculaCertificada;
      const maxMatricula = Math.max(...schools.map(s => s.metrics.matriculaCertificada));
      const percentage = (matricula / maxMatricula) * 100;
      
      return `
        <div class="comparison-metric-row">
          <div class="school-name-label">${school.name.substring(0, 20)}${school.name.length > 20 ? '...' : ''}</div>
          <div class="metric-bar-wrapper">
            <div class="metric-progress-bar">
              <div class="metric-progress-fill programs-fill" style="width: ${percentage}%"></div>
            </div>
            <span class="metric-result">${matricula}</span>
          </div>
        </div>
      `;
    }).join('');
  }
}

// Funci√≥n para generar tabla de detalles
function generateDetailsComparison(schools) {
  console.log('üìã Generando comparaci√≥n de detalles para', schools.length, 'escuelas');
  const featuresComparison = $('#featuresComparison');
  
  if(!featuresComparison) {
    console.error('‚ùå No se encontr√≥ elemento featuresComparison');
    return;
  }
  
  const features = [
    { key: 'type', label: 'Tipo de Centro', icon: 'building' },
    { key: 'level', label: 'Nivel Educativo', icon: 'mortarboard' },
    { key: 'gender', label: 'G√©nero', icon: 'people' },
    { key: 'language', label: 'Idioma Principal', icon: 'translate' },
    { key: 'location', label: 'Municipio', icon: 'geo-alt' },
    { key: 'matriculaCertificada', label: 'Matr√≠cula Certificada', icon: 'person-check', isMetric: true },
    { key: 'tasaDesercion', label: 'Tasa de Deserci√≥n', icon: 'arrow-down-circle', isMetric: true, format: 'percentage' },
    { key: 'tasaAsistencia', label: 'Tasa de Asistencia', icon: 'check-circle', isMetric: true, format: 'percentage' },
    { key: 'inversionPorEstudiante', label: 'Inversi√≥n por Estudiante', icon: 'currency-dollar', isMetric: true, format: 'currency' },
    { key: 'totalMaestros', label: 'Total de Maestros', icon: 'people-fill', isMetric: true }
  ];
  
  featuresComparison.innerHTML = `
    <div class="comparison-table">
      <div class="comparison-table-header">
        <h6>Comparaci√≥n Detallada</h6>
      </div>
      
      <!-- Encabezado con nombres de escuelas -->
      <div class="comparison-row comparison-header-row">
        <div class="feature-label">
          <i class="bi bi-building"></i>
          Caracter√≠sticas
        </div>
        ${schools.map(school => `
          <div class="feature-value school-header">
            <div class="school-header-info">
              <div class="school-avatar-small">${school.name.charAt(0).toUpperCase()}</div>
              <div class="school-header-text">
                <span class="school-header-name">${school.name}</span>
                <span class="school-header-type">${school.type} ‚Ä¢ ${school.location}</span>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      
      ${features.map(feature => `
        <div class="comparison-row">
          <div class="feature-label">
            <i class="bi bi-${feature.icon}"></i>
            ${feature.label}
          </div>
          ${schools.map(school => {
            let value;
            if (feature.isMetric) {
              value = school.metrics[feature.key];
              if (feature.format === 'percentage') {
                value = `${value.toFixed(2)}%`;
              } else if (feature.format === 'currency') {
                value = `$${value.toLocaleString()}`;
              }
            } else {
              value = school[feature.key];
            }
            
            return `
              <div class="feature-value">
                <span class="feature-value-data">${value}</span>
              </div>
            `;
          }).join('')}
        </div>
      `).join('')}
    </div>
  `;
  
  // Generar comparaci√≥n de servicios
  generateServicesComparison(schools);
}

// Funci√≥n para generar comparaci√≥n de servicios
function generateServicesComparison(schools) {
  const servicesGrid = $('#servicesComparisonGrid');
  
  // Servicios organizados por categor√≠as
  const serviceCategories = {
    'Infraestructura Acad√©mica': [
      { name: 'Biblioteca', icon: 'book', key: 'biblioteca' },
      { name: 'Laboratorio de Ciencias', icon: 'flask', key: 'labCiencias' },
      { name: 'Laboratorio de Computadoras', icon: 'laptop', key: 'labComputadoras' },
      { name: 'Salones Climatizados', icon: 'snow2', key: 'aireAcondicionado' }
    ],
    'Deportes y Recreaci√≥n': [
      { name: 'Gimnasio', icon: 'building', key: 'gimnasio' },
      { name: 'Cancha Deportiva', icon: 'circle', key: 'canchaDeportiva' },
      { name: 'Piscina', icon: 'water', key: 'piscina' },
      { name: '√Årea de Juegos', icon: 'puzzle', key: 'areaJuegos' }
    ],
    'Servicios Estudiantiles': [
      { name: 'Cafeter√≠a', icon: 'cup-hot', key: 'cafeteria' },
      { name: 'Transporte Escolar', icon: 'bus-front', key: 'transporteEscolar' },
      { name: 'Enfermer√≠a', icon: 'heart-pulse', key: 'enfermeria' },
      { name: 'Orientaci√≥n Acad√©mica', icon: 'person-check', key: 'orientacionAcademica' }
    ],
    'Servicios Especializados': [
      { name: 'Actividades Extracurriculares', icon: 'palette', key: 'actividadesExtra' },
      { name: 'Educaci√≥n Especial', icon: 'universal-access', key: 'educacionEspecial' },
      { name: 'Wifi/Internet', icon: 'wifi', key: 'wifi' },
      { name: 'Seguridad', icon: 'shield-check', key: 'seguridad' }
    ]
  };

  // Generar datos de servicios realistas para cada escuela
  const schoolServices = schools.map(school => {
    const services = {};
    Object.values(serviceCategories).flat().forEach(service => {
      // Asignar servicios basados en el tipo de escuela y nombre
      if (school.name.includes('Ismael Maldonado Lugaro')) {
        services[service.key] = ['biblioteca', 'labCiencias', 'cafeteria', 'wifi', 'transporteEscolar', 'orientacionAcademica', 'actividadesExtra'].includes(service.key);
      } else if (school.name.includes('Intermedia Coqui')) {
        services[service.key] = ['biblioteca', 'labComputadoras', 'gimnasio', 'cafeteria', 'wifi', 'enfermeria', 'seguridad', 'aireAcondicionado'].includes(service.key);
      } else {
        // Para otras escuelas, asignar aleatoriamente pero de forma consistente
        services[service.key] = Math.random() > 0.4;
      }
    });
    return services;
  });

  servicesGrid.innerHTML = `
    <div class="services-comparison-table">
      <div class="services-table-header">
        <h6><i class="bi bi-gear-fill"></i> Servicios y Facilidades</h6>
      </div>
      
      ${Object.entries(serviceCategories).map(([categoryName, categoryServices]) => `
        <div class="service-category-section">
          <div class="service-category-header">
            <h6>${categoryName}</h6>
          </div>
          
          ${categoryServices.map(service => `
            <div class="comparison-row service-row">
              <div class="feature-label service-label">
                <i class="bi bi-${service.icon}"></i>
                ${service.name}
              </div>
              ${schools.map((school, index) => {
                const hasService = schoolServices[index][service.key];
                return `
                  <div class="feature-value service-value">
                    <div class="service-status ${hasService ? 'available' : 'unavailable'}">
                      <i class="bi bi-${hasService ? 'check-circle-fill' : 'x-circle'}"></i>
                      <span class="service-status-text">${hasService ? 'Disponible' : 'No disponible'}</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `).join('')}
        </div>
      `).join('')}
    </div>
  `;
}

// Funci√≥n para actualizar estad√≠sticas del modal
function updateComparisonStats(savedIds) {
  const compareCountElement = document.getElementById('compareCount');
  const avgRatingElement = document.getElementById('avgRating');
  const municipiosCountElement = document.getElementById('municipiosCount');
  
  if(compareCountElement) {
    compareCountElement.textContent = savedIds.length;
  }
  
  if(savedIds.length > 0) {
    // Calcular promedio de calificaciones
    let totalRating = 0;
    let validRatings = 0;
    const municipios = new Set();
    
    savedIds.forEach(id => {
      const schoolCard = $(`.sf-card[data-id="${id}"]`);
      if(schoolCard) {
        const rating = parseFloat(schoolCard.dataset.rating);
        if(!isNaN(rating)) {
          totalRating += rating;
          validRatings++;
        }
        
        const municipio = schoolCard.querySelector('.municipio')?.textContent?.trim();
        if(municipio) {
          municipios.add(municipio);
        }
      }
    });
    
    if(avgRatingElement) {
      avgRatingElement.textContent = validRatings > 0 ? 
        (totalRating / validRatings).toFixed(1) : '--';
    }
    
    if(municipiosCountElement) {
      municipiosCountElement.textContent = municipios.size;
    }
  } else {
    if(avgRatingElement) avgRatingElement.textContent = '--';
    if(municipiosCountElement) municipiosCountElement.textContent = '--';
  }
}

// Funci√≥n para inicializar eventos de comparaci√≥n
function initComparisonEvents() {
  // Event listeners para remover escuelas
  $$('.remove-from-comparison').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      let saved = getSaved();
      const index = saved.indexOf(id);
      if(index > -1) {
        saved.splice(index, 1);
        setSaved(saved);
        
        // Actualizar la tarjeta en la lista principal
        const schoolCard = $(`.sf-card[data-id="${id}"]`);
        if(schoolCard) {
          const saveBtn = schoolCard.querySelector('.js-save');
          if(saveBtn) {
            saveBtn.setAttribute('aria-pressed', 'false');
            saveBtn.innerHTML = '<i class="bi bi-bookmark"></i>';
          }
        }
        
        // Regenerar contenido de comparaci√≥n
        generateComparisonContent();
        
        // Mostrar notificaci√≥n
        showNotification('Escuela removida de la comparaci√≥n', 'info');
      }
    });
  });
  
  // Event listeners para ver detalles
  $$('.view-details').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const schoolCard = $(`.sf-card[data-id="${id}"]`);
      if(schoolCard) {
        const detailsBtn = schoolCard.querySelector('.js-quickview');
        if(detailsBtn) {
          detailsBtn.click();
        }
      }
    });
  });
}

// Funci√≥n para mostrar escuela en el mapa
function showOnMap(schoolId) {
  const schoolCard = $(`.sf-card[data-id="${schoolId}"]`);
  if(schoolCard && map) {
    const lat = parseFloat(schoolCard.dataset.lat);
    const lng = parseFloat(schoolCard.dataset.lng);
    
    if(!isNaN(lat) && !isNaN(lng)) {
      // Cambiar a vista de mapa
      $('#btnMapMode').click();
      
      // Centrar en la escuela
      setTimeout(() => {
        map.setView([lat, lng], 15);
        
        // Encontrar y abrir el marcador
        markers.forEach(marker => {
          if(marker.options.schoolId === schoolId) {
            marker.openPopup();
          }
        });
      }, 500);
      
      // Cerrar el modal de comparaci√≥n
      const modal = bootstrap.Offcanvas.getInstance(document.getElementById('compareOffcanvas'));
      if(modal) {
        modal.hide();
      }
      
      showNotification('Mostrando escuela en el mapa', 'success');
    }
  }
}

// Inicializar el sistema de tabs
function initComparisonTabs() {
  const tabBtns = $$('.tab-btn');
  const tabPanels = $$('.tab-panel');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetTab = btn.dataset.tab;
      
      // Remover clase active de todos los tabs y panels
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanels.forEach(p => p.classList.remove('active'));
      
      // Activar tab y panel correspondiente
      btn.classList.add('active');
      const targetPanel = document.getElementById(`tab-${targetTab}`);
      if(targetPanel) {
        targetPanel.classList.add('active');
      }
      
      // Cargar contenido espec√≠fico del tab si es necesario
      if(targetTab === 'academics') {
        console.log('üéì Cargando pesta√±a acad√©mica');
        // Usar la funci√≥n que ya existe con datos reales
        const schoolsToCompare = getSavedSchools();
        console.log('üìö Escuelas para comparar:', schoolsToCompare.length);
        if(schoolsToCompare.length > 0) {
          generateAcademicComparison(schoolsToCompare);
          generateKeyMetricsComparison(schoolsToCompare);
          console.log('‚úÖ Contenido acad√©mico generado');
        } else {
          console.log('‚ö†Ô∏è No hay escuelas para comparar');
        }
      } else if(targetTab === 'details') {
        console.log('üìã Cargando pesta√±a de detalles');
        // Usar la funci√≥n que ya existe con datos reales
        const schoolsToCompare = getSavedSchools();
        console.log('üìä Escuelas para comparar:', schoolsToCompare.length);
        if(schoolsToCompare.length > 0) {
          generateDetailsComparison(schoolsToCompare);
          generateServicesComparison(schoolsToCompare);
          console.log('‚úÖ Contenido de detalles generado');
        } else {
          console.log('‚ö†Ô∏è No hay escuelas para comparar');
        }
      }
    });
  });
}

function showNotification(message, type = 'info') {
  // Crear notificaci√≥n toast
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
  toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  const bsToast = new bootstrap.Toast(toast);
  bsToast.show();
  
  // Remover despu√©s de que se oculte
  toast.addEventListener('hidden.bs.toast', () => {
    toast.remove();
  });
}

function initSavesForNewCards(){
  $$('.sf-card .js-save:not(.wired)').forEach(btn=>{
    btn.classList.add('wired');
    const id = btn.closest('.sf-card').dataset.id;
    if(getSaved().includes(id)){ btn.setAttribute('aria-pressed','true'); btn.innerHTML='<i class="bi bi-bookmark-fill"></i>'; }
    btn.addEventListener('click', ()=>{
      let cur = getSaved(); const idx = cur.indexOf(id);
      if(idx>-1){ cur.splice(idx,1); btn.setAttribute('aria-pressed','false'); btn.innerHTML='<i class="bi bi-bookmark"></i>'; }
      else{ cur.push(id); btn.setAttribute('aria-pressed','true'); btn.innerHTML='<i class="bi bi-bookmark-fill"></i>'; }
      setSaved(cur);
    });
  });
}

/* ===== compact toggle ===== */
$('#density').addEventListener('click', ()=> document.body.classList.toggle('list-compact'));

/* ===== Lista <-> Mapa ===== */
let map, markers = [];
function schoolsFromDOM(){
  return $$('.sf-card').map(c => ({
    id: c.dataset.id,
    el: c,
    name: c.querySelector('.sf-title').textContent.trim(),
    lat: parseFloat(c.dataset.lat), lng: parseFloat(c.dataset.lng),
    href: c.querySelector('.sf-title').href
  })).filter(s => Number.isFinite(s.lat) && Number.isFinite(s.lng));
}
function initMap(){
  if (map) { map.invalidateSize(); return; }
  map = L.map('mapFull').setView([center.lat, center.lng], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
  renderMarkers();
}
function renderMarkers(){
  markers.forEach(m=>map.removeLayer(m)); markers = [];
  const schools = schoolsFromDOM();
  const bounds = [];
  schools.forEach(s=>{
    // Obtener el tipo de escuela del elemento DOM para color coordinado
    const tipoElement = s.el.querySelector('.tipo[data-type]');
    const schoolType = tipoElement ? tipoElement.getAttribute('data-type') : null;
    const markerColor = getMarkerColorForSchoolType(schoolType);
    
    // Crear marcador con color coordinado (igual que en index.html)
    const schoolIcon = L.divIcon({
      className: 'school-marker-coordinated',
      html: `<div style="background: ${markerColor}; color: white; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"><i class="bi bi-geo-alt-fill" style="transform: rotate(45deg); font-size: 14px;"></i></div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });
    
    const mk = L.marker([s.lat,s.lng], { icon: schoolIcon }).addTo(map)
      .bindPopup(`<strong>${s.name}</strong><br><span style="color: ${markerColor}; font-weight: 600;">${schoolType || 'Tipo no especificado'}</span><br><a href="${s.href}" target="_blank">Ver perfil</a>`);
    
    mk.on('click', ()=>{
      $$('.sf-card').forEach(c=>c.classList.remove('is-active'));
      s.el.classList.add('is-active');
      s.el.scrollIntoView({behavior:'smooth', block:'center'});
    });
    s.el.addEventListener('mouseenter', ()=> mk.openPopup());
    markers.push(mk); bounds.push([s.lat,s.lng]);
  });
  if(bounds.length){ map.fitBounds(bounds, {padding:[30,30]}); }
}
$('#btnMapMode').addEventListener('click', ()=>{
  $('#listView').style.display='none';
  $('#mapView').style.display='block';
  setTimeout(()=>{ initMap(); }, 150);
});
$('#btnBackList').addEventListener('click', ()=>{
  $('#mapView').style.display='none';
  $('#listView').style.display='block';
  window.scrollTo({top: resultsList.offsetTop - 80, behavior:'smooth'});
});

/* ===== filtros (stub) ===== */
$('#btnApplyTop').addEventListener('click', ()=>{
  // Lee valores de filtros, reinicia la lista y vuelve a cargar:
  page=0; loaded=0; resultsList.innerHTML='';
  if(map) renderMarkers();
  loadNextPage();
});
$('#orderSelect').addEventListener('change', ()=>{ /* TODO: ordenar */ });

// Funci√≥n para actualizar distancias en tarjetas existentes
function updateDistancesInExistingCards() {
  if (!userLocation) {
    console.log('‚ùå No hay ubicaci√≥n del usuario disponible');
    return;
  }
  
  const cards = $$('.sf-card[data-lat][data-lng]');
  console.log('üó∫Ô∏è Actualizando distancias para', cards.length, 'tarjetas');
  
  cards.forEach(card => {
    const lat = parseFloat(card.dataset.lat);
    const lng = parseFloat(card.dataset.lng);
    
    if (Number.isFinite(lat) && Number.isFinite(lng)) {
      const distance = calculateDistance(userLocation.lat, userLocation.lng, lat, lng);
      const distanceElement = card.querySelector('.distance-info');
      const distanceText = card.querySelector('.distance');
      
      if (distanceElement && distanceText) {
        distanceText.textContent = formatDistance(distance);
        distanceElement.classList.remove('d-none');
        console.log('‚úÖ Distancia actualizada:', distance.toFixed(2), 'mi para tarjeta', card.dataset.id);
      } else {
        console.log('‚ùå No se encontraron elementos de distancia en tarjeta', card.dataset.id);
      }
    } else {
      console.log('‚ùå Coordenadas inv√°lidas en tarjeta', card.dataset.id, 'lat:', lat, 'lng:', lng);
    }
  });
}

/* ===== bootstrap ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  observer.observe(sentinel);
  loadNextPage();           // primer lote
  initSavesForNewCards();   // inicial
  
  // Obtener ubicaci√≥n del usuario para calcular distancias
  try {
    await getUserLocation();
    console.log('üìç Ubicaci√≥n del usuario obtenida:', userLocation);
    updateDistancesInExistingCards();
    console.log('üó∫Ô∏è Ubicaci√≥n obtenida y distancias calculadas');
    
    // Aplicar filtro de distancia despu√©s de obtener ubicaci√≥n
    setTimeout(() => {
      console.log('üîÑ Aplicando filtro de distancia inicial...');
      filterCardsByDistance();
    }, 1000);
    
    // Reintento despu√©s de 2 segundos para asegurar que se muestren las distancias
    setTimeout(() => {
      console.log('üîÑ Reintentando actualizaci√≥n de distancias...');
      updateDistancesInExistingCards();
    }, 2000);
    
  } catch (error) {
    console.warn('‚ö†Ô∏è No se pudo obtener la ubicaci√≥n:', error);
  }
});

const drawerEl = document.getElementById('schoolDrawer');
const drawer = new bootstrap.Offcanvas(drawerEl);

function loadSchoolQuick(id){
  // Encontrar la escuela para mostrar su nombre inmediatamente
  const school = allSchoolsLoaded.find(s => s.id === parseInt(id)) || allSchoolsLoaded.find(s => s.id === String(id));
  
  // Mostrar estado de carga con nombre de la escuela si est√° disponible
  const titleElement = document.getElementById('schoolDrawerLabel');
  const subtitleElement = document.getElementById('sdSubtitle');
  
  if (school) {
    titleElement.textContent = school.name;
    subtitleElement.textContent = 'Cargando informaci√≥n...';
  } else {
    titleElement.textContent = 'Cargando...';
    subtitleElement.textContent = 'Informaci√≥n de la escuela';
  }
  
  // Abrir modal inmediatamente con estado de carga
  const oc = bootstrap.Offcanvas.getOrCreateInstance('#schoolDrawer');
  oc.show();
  
  // Cargar datos completos con una peque√±a delay para mejor UX
  setTimeout(() => {
    openSchoolDrawer(id);
  }, 200);
}

document.querySelectorAll('.js-quickview').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const id = btn.dataset.id;
    loadSchoolQuick(id);
    // URL compartible
    history.pushState({ school:id }, '', `?school=${id}`);
  });
});

// Cierra ‚Üí limpia la URL si tra√≠a ?school
drawerEl.addEventListener('hidden.bs.offcanvas', ()=>{
  const url = new URL(location.href);
  if (url.searchParams.get('school')) {
    url.searchParams.delete('school');
    history.replaceState({}, '', url.pathname + url.search);
  }
});

// Al cargar, reabrir si viene con ?school=ID
window.addEventListener('DOMContentLoaded', ()=>{
  const url = new URL(location.href);
  const id = url.searchParams.get('school');
  if (id){
    loadSchoolQuick(id);
    drawer.show();
  }
});


 // Abre el drawer y pinta datos
  async function openSchoolDrawer(id){
    // 1) Traer datos (mock de ejemplo)
    // Reemplaza por: const data = await (await fetch(`/api/schools/${id}`)).json();
    const data = getMockSchool(id);

    // 2) Pinta encabezado
    document.getElementById('schoolDrawerLabel').textContent = data.name;
    document.getElementById('sdSubtitle').textContent = `${data.municipio} ‚Ä¢ C√≥digo: ${data.code}`;
    document.getElementById('sdLogo').src = data.logo || 'https://placehold.co/64x64';
    
    // Actualizar badges con span interno
    const levelBadge = document.getElementById('sdLevel');
    levelBadge.querySelector('span').textContent = data.level;
    
    document.getElementById('sdGrades').textContent = data.grades;
    
    const statusBadge = document.getElementById('sdStatus');
    statusBadge.className = `sd-badge ${data.status==='Apta' ? 'sd-badge-success' : 'sd-badge-secondary'}`;
    statusBadge.querySelector('span').textContent = data.status;
    
    // Actualizar elementos de la grid oficial
    setText('sdLevel2', data.level);
    setText('sdGrades2', data.grades);
    setText('sdRegion', data.municipio.toUpperCase());
    setText('sdStatusText', data.status === 'Apta' ? 'Apta para abrir' : data.status);
    setText('sdModalidad2', 'Horario Regular');
    setText('sdHorario2', `Lunes a viernes ${data.horario}`);

    // 3) Contacto + ficha
    setText('sdAddress', data.address);
    
    const phoneEl = document.getElementById('sdPhone');
    phoneEl.textContent = data.phone;
    phoneEl.href = `tel:${data.phone}`;
    
    const emailEl = document.getElementById('sdEmail');
    emailEl.textContent = data.email;
    emailEl.href = `mailto:${data.email}`;
    
    setText('sdCode', data.code);
    setText('sdMunicipio', data.municipio);
    setText('sdModalidad', data.modalidad);
    setText('sdHorario', data.horario);
    setText('sdNiveles', data.niveles);
    setText('sdEspecialidad', data.especialidad);

    // 4) Star rating - actualizar las estrellas
    document.getElementById('sdAcad').innerHTML = data.starRating.acad;
    document.getElementById('sdCalidad').innerHTML = data.starRating.calidad;
    document.getElementById('sdAdmin').innerHTML = data.starRating.admin;

    // 5) Proficiencia (barras)
    setProg('es', data.proficiency.es, 61);
    setProg('ma', data.proficiency.ma, 49);
    setProg('en', data.proficiency.en, 56);
    setProg('ci', data.proficiency.ci, 52);

    // 6) Indicadores
    setText('m-asistencia', data.metrics.asistencia);
    setText('m-matricula', data.metrics.matricula);
    setText('m-matricula-exp', data.metrics.matriculaEsperada);
    setText('m-maestros', data.metrics.maestros);
    setText('m-desercion', data.metrics.desercion);
    setText('m-inversion', data.metrics.inversion);

    // 7) Mostrar modal primero
    const oc = bootstrap.Offcanvas.getOrCreateInstance('#schoolDrawer');
    oc.show();

    // 8) Inicializar mapa despu√©s de que el modal est√© completamente cargado
    console.log('üó∫Ô∏è Preparando inicializaci√≥n del mapa...');
    
    // Usar un timeout para asegurar que el modal est√© completamente renderizado
    setTimeout(() => {
      console.log('‚úÖ Inicializando mapa con datos:', { lat: data.lat, lng: data.lng, name: data.name });
      initDrawerMap(data.lat, data.lng, data.name, data.address);
    }, 300);
  }

  function setText(id, val){ document.getElementById(id).textContent = val ?? '‚Äî'; }
  function setProg(key, value, goal){
    value = Math.max(0, Math.min(100, Number(value)||0));
    document.getElementById(`p-${key}`).textContent = value.toFixed(2) + '%';
    document.getElementById(`f-${key}`).style.width = value + '%';
    document.getElementById(`g-${key}`).style.left = (goal||0) + '%';
  }

  // Mock r√°pido para demo (c√°mbialo por tu API)
  function getMockSchool(id){
    // Generar datos coherentes con las tarjetas existentes
    const schoolData = fakeSchool(parseInt(id) - 1);
    
    const addresses = [
      'CARR 638 HM 5 BO MIRAFLORES ARECIBO PR, 00612',
      'Ave. Luis Mu√±oz Rivera #123, Guaynabo PR, 00969',  
      'Calle Central #456, Bayam√≥n PR, 00961',
      'Carretera 181 Km 3.2, Carolina PR, 00979',
      'Ave. Jos√© de Diego #789, Ponce PR, 00731'
    ];
    
    const phones = [
      '(787) 816-8006', '(787) 721-2400', '(787) 786-2885', 
      '(787) 757-2000', '(787) 843-2000'
    ];
    
    const emails = [
      `d${10000 + parseInt(id)}@de.pr.gov`,
      `info@${schoolData.nombre.toLowerCase().replace(/\s+/g, '')}.edu`,
      `contacto@escuela${id}.pr.gov`
    ];

    return {
      id,
      name: schoolData.nombre,
      logo: schoolData.logo,
      level: schoolData.niveles.toUpperCase(),
      grades: schoolData.niveles === 'Primario' ? 'K‚Äì8' : schoolData.niveles === 'Secundario' ? '9‚Äì12' : 'K‚Äì12',
      status: schoolData.estado === 'ok' ? 'Apta' : 'Por determinar',
      code: schoolData.codigo,
      municipio: schoolData.municipio,
      modalidad: schoolData.modalidad,
      horario: schoolData.horario,
      niveles: schoolData.niveles,
      especialidad: schoolData.especialidad,
      address: addresses[parseInt(id) % addresses.length],
      phone: phones[parseInt(id) % phones.length],
      email: emails[parseInt(id) % emails.length],
      lat: schoolData.lat, 
      lng: schoolData.lng,
      starRating: { 
        acad: '‚òÖ'.repeat(Math.floor(schoolData.rating)), 
        calidad: '‚òÖ'.repeat(Math.floor(schoolData.rating)), 
        admin: '‚òÖ'.repeat(Math.floor(schoolData.rating - 0.5)) 
      },
      proficiency: { 
        es: rand(75, 95).toFixed(2), 
        ma: rand(70, 90).toFixed(2), 
        en: rand(80, 95).toFixed(2), 
        ci: rand(60, 85).toFixed(2) 
      },
      metrics: {
        asistencia: rand(85, 92).toFixed(2) + '%',
        matricula: Math.floor(rand(150, 300)).toString(),
        matriculaEsperada: Math.floor(rand(140, 280)).toString(),
        maestros: Math.floor(rand(12, 35)).toString(),
        desercion: rand(2, 8).toFixed(2) + '%',
        inversion: '$' + Math.floor(rand(12000, 20000)).toLocaleString(),
      }
    };
  }

  // Wire: todos los "Ver perfil"
  document.querySelectorAll('.js-open-profile').forEach(btn=>{
    btn.addEventListener('click', e=>{
      e.preventDefault();
      const id = btn.dataset.id || btn.closest('[data-id]')?.dataset.id || 1;
      openSchoolDrawer(id);
    });
  });

  // ===== FUNCIONALIDAD DE TABS =====
  function handleTabClick(tabType) {
    // Actualizar tabs visuales
    document.querySelectorAll('.sf-results-tabs .nav-link').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Activar el tab clickeado
    event.currentTarget.classList.add('active');
    
    // Filtrar escuelas seg√∫n el tab
    const allCards = document.querySelectorAll('[data-school-card]');
    
    switch(tabType) {
      case 'todos':
        // Resetear a la lista original completa
        resetToFullList();
        break;
        
      case 'top':
        // Mostrar solo escuelas top (rating >= 4.5)
        let topCount = 0;
        allCards.forEach(card => {
          const rating = parseFloat(card.querySelector('.rating-number')?.textContent || '0');
          if (rating >= 4.5) {
            card.style.display = '';
            topCount++;
          } else {
            card.style.display = 'none';
          }
        });
        updateResultsCount(topCount);
        break;
        
      case 'bilingues':
        // Mostrar solo escuelas biling√ºes (que tengan "Ingl√©s" en especialidad)
        let bilingueCount = 0;
        allCards.forEach(card => {
          const hasIngles = card.textContent.toLowerCase().includes('ingl√©s') || 
                           card.textContent.toLowerCase().includes('ingles');
          if (hasIngles) {
            card.style.display = '';
            bilingueCount++;
          } else {
            card.style.display = 'none';
          }
        });
        updateResultsCount(bilingueCount);
        break;
        
      case 'valorados':
        // Mostrar solo escuelas m√°s valoradas (rating >= 4.0)
        let valoradosCount = 0;
        allCards.forEach(card => {
          const rating = parseFloat(card.querySelector('.rating-number')?.textContent || '0');
          if (rating >= 4.0) {
            card.style.display = '';
            valoradosCount++;
          } else {
            card.style.display = 'none';
          }
        });
        updateResultsCount(valoradosCount);
        break;
    }
  }
  
  function updateResultsCount(count) {
    console.log('üìä Actualizando contador de resultados:', count);
    
    // Actualizar el contador en el hero si existe
    const heroNumber = document.querySelector('.hero-number');
    if (heroNumber) {
      heroNumber.textContent = count;
      console.log('‚úÖ Contador hero actualizado:', count);
    }
    
    // Actualizar cualquier otro contador que pueda existir
    const resultsCount = document.querySelector('.results-count');
    if (resultsCount) {
      resultsCount.textContent = count;
    }
    
    // Mostrar mensaje si no hay resultados
    const noResults = document.querySelector('.no-results');
    if (count === 0) {
      if (!noResults) {
        const message = document.createElement('div');
        message.className = 'no-results alert alert-info mt-3';
        message.innerHTML = `
          <i class="bi bi-info-circle"></i> 
          No se encontraron escuelas en el rango de distancia seleccionado.
          <button class="btn btn-sm btn-outline-primary ms-2" onclick="resetDistanceFilter()">
            Mostrar todas
          </button>
        `;
        resultsList.appendChild(message);
      }
    } else if (noResults) {
      noResults.remove();
    }
  }
  
  function resetToFullList() {
    // Limpiar la lista actual
    resultsList.innerHTML = '';
    
    // Resetear variables de paginaci√≥n
    page = 0;
    loading = false;
    loaded = 0;
    total = SCHOOLS_TOTAL;
    
    // Mostrar el bot√≥n de cargar m√°s si estaba oculto
    loadMoreBtn.classList.remove('d-none');
    
    // Reconectar el observer para infinite scroll
    if (observer && sentinel) {
      observer.observe(sentinel);
    }
    
    // Cargar la primera p√°gina
    loadNextPage();
    
    // Actualizar contador al total original
    updateResultsCount(SCHOOLS_TOTAL);
  }

  // UX Enhancement Functions
  function updateFilters() {
    const activeFilters = [];
    const filterSections = {popular: 0, type: 0};
    
    // Check popular filters
    if (document.getElementById('pFast')?.checked) {
      activeFilters.push({name: 'Respuesta r√°pida', id: 'pFast'});
      filterSections.popular++;
    }
    if (document.getElementById('pOpen')?.checked) {
      activeFilters.push({name: 'Con Open Days', id: 'pOpen'});
      filterSections.popular++;
    }
    if (document.getElementById('pPhotos')?.checked) {
      activeFilters.push({name: 'Con fotos', id: 'pPhotos'});
      filterSections.popular++;
    }
    
    // Check type filters
    if (document.getElementById('tJardin')?.checked) {
      activeFilters.push({name: 'Jard√≠n Infantil', id: 'tJardin'});
      filterSections.type++;
    }
    if (document.getElementById('tColegio')?.checked) {
      activeFilters.push({name: 'Colegio', id: 'tColegio'});
      filterSections.type++;
    }
    if (document.getElementById('tInstituto')?.checked) {
      activeFilters.push({name: 'Instituto', id: 'tInstituto'});
      filterSections.type++;
    }
    
    // Update section badges
    updateSectionBadge('popularBadge', filterSections.popular);
    updateSectionBadge('typeBadge', filterSections.type);
    
    // Update active filters display
    updateActiveFilters(activeFilters);
    
  }

  function updateSectionBadge(badgeId, count) {
    const badge = document.getElementById(badgeId);
    if (badge) {
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }
  }

  function updateActiveFilters(filters) {
    const activeFiltersPreview = document.getElementById('activeFiltersPreview');
    const activeFiltersTags = document.getElementById('activeFiltersTags');
    
    if (activeFiltersPreview && activeFiltersTags) {
      if (filters.length > 0) {
        activeFiltersPreview.style.display = 'block';
        activeFiltersTags.innerHTML = filters.map(filter => `
          <div class="sf-active-tag">
            ${filter.name}
            <button onclick="removeFilter('${filter.id}')">
              <i class="bi bi-x"></i>
            </button>
          </div>
        `).join('');
      } else {
        activeFiltersPreview.style.display = 'none';
      }
    }
  }

  function removeFilter(filterId) {
    const checkbox = document.getElementById(filterId);
    if (checkbox) {
      checkbox.checked = false;
      updateFilters();
    }
  }

  function clearAllFilters() {
    // Uncheck all filters
    document.querySelectorAll('.sf-option input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    
    // Reset distance filter
    resetDistanceFilter();
    
    updateFilters();
  }

  // =============================================
  // FILTRO DE DISTANCIA
  // =============================================
  
  let maxDistance = 50; // Distancia m√°xima en millas
  
  function updateDistanceFilter(value) {
    maxDistance = parseInt(value);
    
    // Actualizar UI
    const distanceLabel = document.getElementById('distanceLabel');
    const distanceValue = document.getElementById('distanceValue');
    const distanceFill = document.getElementById('distanceFill');
    const presets = document.querySelectorAll('.sf-distance-preset');
    
    // Actualizar textos
    if (maxDistance >= 50) {
      distanceLabel.textContent = 'Cualquier distancia';
      distanceValue.textContent = '';
    } else {
      distanceLabel.textContent = 'Hasta';
      distanceValue.textContent = `${maxDistance} mi`;
    }
    
    // Actualizar barra de progreso
    const percentage = (maxDistance / 50) * 100;
    distanceFill.style.width = `${percentage}%`;
    
    // Actualizar presets activos
    presets.forEach(preset => {
      preset.classList.remove('active');
      const presetValue = preset.textContent === 'Todo' ? 50 : parseInt(preset.textContent);
      if (presetValue === maxDistance) {
        preset.classList.add('active');
      }
    });
    
    // Filtrar tarjetas por distancia
    filterCardsByDistance();
    
    // Actualizar badge del filtro
    updateDistanceBadge();
  }
  
  function setDistanceFilter(miles) {
    const slider = document.getElementById('distanceRange');
    slider.value = miles;
    updateDistanceFilter(miles);
  }
  
  function filterCardsByDistance() {
    console.log('üîç Iniciando filtro por distancia, maxDistance:', maxDistance);
    
    if (!userLocation) {
      console.log('‚ùå No hay ubicaci√≥n del usuario para filtrar');
      return;
    }
    
    const cards = document.querySelectorAll('.sf-card[data-lat][data-lng]');
    let visibleCount = 0;
    
    console.log('üìã Filtrando', cards.length, 'tarjetas con distancia m√°xima:', maxDistance, 'mi');
    
    cards.forEach((card, index) => {
      const lat = parseFloat(card.dataset.lat);
      const lng = parseFloat(card.dataset.lng);
      
      if (Number.isFinite(lat) && Number.isFinite(lng)) {
        const distance = calculateDistance(userLocation.lat, userLocation.lng, lat, lng);
        
        if (maxDistance >= 50 || distance <= maxDistance) {
          card.style.display = '';
          visibleCount++;
          console.log(`‚úÖ Tarjeta ${index + 1}: ${distance.toFixed(1)}mi - VISIBLE`);
        } else {
          card.style.display = 'none';
          console.log(`‚ùå Tarjeta ${index + 1}: ${distance.toFixed(1)}mi - OCULTA (l√≠mite: ${maxDistance}mi)`);
        }
      } else {
        console.log(`‚ö†Ô∏è Tarjeta ${index + 1}: Coordenadas inv√°lidas (${lat}, ${lng})`);
      }
    });
    
    console.log('üéØ Filtro completado:', visibleCount, 'tarjetas visibles de', cards.length);
    
    // Actualizar contador de resultados
    updateResultsCount(visibleCount);
  }
  
  function updateDistanceBadge() {
    const badge = document.getElementById('distanceBadge');
    if (maxDistance < 50) {
      badge.textContent = '1';
      badge.style.display = '';
    } else {
      badge.textContent = '0';
      badge.style.display = 'none';
    }
  }
  
  function resetDistanceFilter() {
    setDistanceFilter(50);
  }

  // Variable global para el mapa del drawer
  let drawerMapInstance = null;

  // Funci√≥n simple para mostrar mapa mockup est√°tico
  async function initDrawerMap(lat, lng, schoolName, address) {
    console.log('üó∫Ô∏è === INICIANDO MAPA MOCKUP ===');
    console.log('Par√°metros recibidos:', { lat, lng, schoolName, address });
    
    const mapContainer = document.getElementById('drawerMap');
    
    if (!mapContainer) {
      console.error('‚ùå CONTENEDOR NO ENCONTRADO');
      return;
    }

    // Obtener ubicaci√≥n del usuario
    if (!userLocation) {
      userLocation = await getUserLocation();
      console.log('üìç Ubicaci√≥n del usuario:', userLocation);
    }

    // Calcular distancia
    const distance = calculateDistance(userLocation.lat, userLocation.lng, lat, lng);
    console.log('üìè Distancia calculada:', distance, 'km');

    // Crear mapa mockup simple
    mapContainer.innerHTML = `
      <div style="
        width: 100%; 
        height: 250px; 
        position: relative; 
        background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 30%, #81C784 70%, #A5D6A7 100%);
        border-radius: 8px; 
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
      ">
        
        <!-- Fondo del mapa simulado -->
        <div style="
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-image: 
            linear-gradient(0deg, rgba(255,255,255,0.8) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.8) 1px, transparent 1px),
            radial-gradient(circle at 30% 40%, rgba(76, 175, 80, 0.3) 0%, transparent 25%),
            radial-gradient(circle at 70% 60%, rgba(33, 150, 243, 0.2) 0%, transparent 30%);
          background-size: 50px 50px, 50px 50px, 100px 100px, 120px 120px;
          opacity: 0.6;
        "></div>

        <!-- Informaci√≥n superior -->
        <div style="
          position: absolute; 
          top: 0; 
          left: 0; 
          right: 0; 
          background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%); 
          color: white; 
          padding: 16px; 
          z-index: 10;
        ">
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1;">
              <div style="font-weight: 700; font-size: 1rem; margin-bottom: 4px; display: flex; align-items: center;">
                <i class="bi bi-building-fill" style="margin-right: 8px; color: #FFD700; font-size: 1.1rem;"></i>
                ${schoolName}
              </div>
              <div style="font-size: 0.8rem; opacity: 0.9; line-height: 1.3;">
                üìç ${address}
              </div>
            </div>
            <div style="text-align: right; margin-left: 16px;">
              <div style="
                background: var(--brand-600); 
                color: white; 
                padding: 8px 12px; 
                border-radius: 20px; 
                font-size: 0.85rem; 
                font-weight: 700;
                display: inline-block;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
              ">
                üöó ${distance} km
              </div>
              <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 4px;">
                desde tu ubicaci√≥n
              </div>
            </div>
          </div>
        </div>

        <!-- Marcador principal de la escuela -->
        <div style="
          width: 60px;
          height: 60px;
          background: var(--brand-600);
          border: 5px solid white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 28px;
          box-shadow: 0 8px 20px rgba(0,0,0,0.3);
          animation: bounce 2s infinite;
          position: relative;
          z-index: 5;
        ">
          üè´
          
          <!-- Ondas de ubicaci√≥n -->
          <div style="
            position: absolute;
            width: 100px;
            height: 100px;
            border: 3px solid var(--brand-400);
            border-radius: 50%;
            animation: pulse 2s infinite;
            opacity: 0.6;
          "></div>
          <div style="
            position: absolute;
            width: 140px;
            height: 140px;
            border: 2px solid var(--brand-300);
            border-radius: 50%;
            animation: pulse 2s infinite 0.5s;
            opacity: 0.4;
          "></div>
        </div>

        <!-- Informaci√≥n inferior -->
        <div style="
          position: absolute;
          bottom: 16px;
          left: 16px;
          right: 16px;
          display: flex;
          justify-content: space-between;
          align-items: flex-end;
        ">
          <!-- Distancia y tiempo -->
          <div style="
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 8px;
          ">
            <div style="color: var(--brand-600); font-weight: 600;">
              <i class="bi bi-signpost-2"></i> ${distance} km
            </div>
            <div style="color: #666; border-left: 1px solid #ddd; padding-left: 8px;">
              <i class="bi bi-clock"></i> ~${Math.round(distance * 2)} min
            </div>
          </div>

          <!-- Coordenadas -->
          <div style="
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-family: 'Courier New', monospace;
            font-weight: 600;
          ">
            ${lat.toFixed(4)}, ${lng.toFixed(4)}
          </div>
        </div>
      </div>
    `;
    
    console.log('‚úÖ Mapa mockup creado exitosamente');

    // Limpiar contenedor
    mapContainer.innerHTML = '';
    
    // Crear SVG del mapa mockup
    const mapSVG = `
      <svg width="100%" height="250" viewBox="0 0 400 250" style="background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #81C784 100%);">
        <!-- Calles principales -->
        <line x1="0" y1="125" x2="400" y2="125" stroke="white" stroke-width="4" opacity="0.8"/>
        <line x1="200" y1="0" x2="200" y2="250" stroke="white" stroke-width="4" opacity="0.8"/>
        
        <!-- Calles secundarias -->
        <line x1="0" y1="80" x2="400" y2="80" stroke="white" stroke-width="2" opacity="0.6"/>
        <line x1="0" y1="170" x2="400" y2="170" stroke="white" stroke-width="2" opacity="0.6"/>
        <line x1="100" y1="0" x2="100" y2="250" stroke="white" stroke-width="2" opacity="0.6"/>
        <line x1="300" y1="0" x2="300" y2="250" stroke="white" stroke-width="2" opacity="0.6"/>
        
        <!-- √Åreas verdes (parques) -->
        <rect x="30" y="30" width="80" height="60" fill="#66BB6A" opacity="0.7" rx="5"/>
        <rect x="270" y="150" width="100" height="70" fill="#66BB6A" opacity="0.7" rx="5"/>
        
        <!-- Edificios -->
        <rect x="50" y="140" width="12" height="18" fill="#BDBDBD" opacity="0.8"/>
        <rect x="90" y="135" width="12" height="23" fill="#BDBDBD" opacity="0.8"/>
        <rect x="130" y="142" width="12" height="16" fill="#BDBDBD" opacity="0.8"/>
        <rect x="250" y="138" width="12" height="20" fill="#BDBDBD" opacity="0.8"/>
        <rect x="290" y="143" width="12" height="15" fill="#BDBDBD" opacity="0.8"/>
        <rect x="330" y="140" width="12" height="18" fill="#BDBDBD" opacity="0.8"/>
        
        <!-- Sombra del marcador -->
        <ellipse cx="200" cy="145" rx="15" ry="8" fill="rgba(0,0,0,0.2)"/>
        
        <!-- Ondas de ubicaci√≥n -->
        <circle cx="200" cy="125" r="40" fill="none" stroke="#1976D2" stroke-width="2" opacity="0.3">
          <animate attributeName="r" values="20;50;20" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="0.6;0.1;0.6" dur="2s" repeatCount="indefinite"/>
        </circle>
        
        <!-- Pin del marcador -->
        <circle cx="200" cy="125" r="20" fill="#1976D2" stroke="white" stroke-width="4"/>
        
        <!-- Icono de escuela -->
        <text x="200" y="132" text-anchor="middle" font-size="18" fill="white">üè´</text>
        
        <!-- Coordenadas -->
        <text x="390" y="240" text-anchor="end" font-size="10" fill="rgba(0,0,0,0.6)" font-family="monospace">${lat.toFixed(4)}, ${lng.toFixed(4)}</text>
      </svg>
    `;
    
    // Crear HTML del mapa completo
    const mapHTML = `
      <div style="
        width: 100%; 
        height: 250px; 
        position: relative; 
        background: #f8f9fa;
        border-radius: 8px; 
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      ">
        
        <!-- Mapa SVG -->
        ${mapSVG}
        
        <!-- Overlay con informaci√≥n de la escuela -->
        <div style="
          position: absolute; 
          top: 0; 
          left: 0; 
          right: 0; 
          background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 70%, transparent 100%); 
          color: white; 
          padding: 16px; 
          z-index: 10;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 2px;">
                <i class="bi bi-building" style="margin-right: 6px;"></i>${schoolName}
              </div>
              <div style="font-size: 0.75rem; opacity: 0.9;">üìç ${address}</div>
            </div>
            <div style="text-align: right;">
              <div style="
                background: rgba(255,255,255,0.2); 
                color: white; 
                padding: 6px 12px; 
                border-radius: 16px; 
                font-size: 0.8rem; 
                font-weight: 600;
                display: inline-block;
                border: 1px solid rgba(255,255,255,0.3);
              ">
                ÔøΩ ${distance} km
              </div>
              <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 2px;">desde tu ubicaci√≥n</div>
            </div>
          </div>
        </div>

        <!-- Simulaci√≥n visual del mapa -->
        <div style="
          position: absolute;
          top: 60px;
          left: 0;
          right: 0;
          bottom: 0;
          background: 
            radial-gradient(circle at 30% 40%, rgba(76, 175, 80, 0.3) 0%, transparent 25%),
            radial-gradient(circle at 70% 60%, rgba(33, 150, 243, 0.2) 0%, transparent 30%),
            radial-gradient(circle at 50% 80%, rgba(255, 193, 7, 0.2) 0%, transparent 20%),
            linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%),
            linear-gradient(-45deg, rgba(255,255,255,0.1) 25%, transparent 25%);
          background-size: 80px 80px, 120px 120px, 60px 60px, 20px 20px, 20px 20px;
        ">
          <!-- Carreteras simuladas -->
          <div style="
            position: absolute;
            top: 45%;
            left: 0;
            right: 0;
            height: 3px;
            background: #666;
            opacity: 0.4;
          "></div>
          <div style="
            position: absolute;
            top: 0;
            bottom: 0;
            left: 60%;
            width: 3px;
            background: #666;
            opacity: 0.4;
          "></div>
        </div>

        <!-- Marcador de la escuela -->
        <div style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 5;
        ">
          <div style="
            width: 50px;
            height: 50px;
            background: var(--brand-600);
            border: 4px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            animation: bounce 2s infinite;
            position: relative;
          ">
            <i class="bi bi-building"></i>
            <!-- Ondas de ubicaci√≥n -->
            <div style="
              position: absolute;
              width: 80px;
              height: 80px;
              border: 2px solid var(--brand-400);
              border-radius: 50%;
              animation: pulse 2s infinite;
              opacity: 0.6;
            "></div>
          </div>
        </div>

        <!-- Tu ubicaci√≥n (simulada) -->
        <div style="
          position: absolute;
          top: 25%;
          left: 25%;
          transform: translate(-50%, -50%);
          z-index: 4;
        ">
          <div style="
            width: 16px;
            height: 16px;
            background: #4CAF50;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          "></div>
          <div style="
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
            white-space: nowrap;
          ">
            Tu ubicaci√≥n
          </div>
        </div>

        <!-- L√≠nea de distancia -->
        <svg style="
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 3;
          pointer-events: none;
        ">
          <defs>
            <pattern id="dashed" patternUnits="userSpaceOnUse" width="8" height="8">
              <rect width="4" height="8" fill="var(--brand-400)" opacity="0.6"/>
            </pattern>
          </defs>
          <line x1="25%" y1="25%" x2="50%" y2="50%" stroke="url(#dashed)" stroke-width="2"/>
        </svg>

        <!-- Informaci√≥n de distancia y tiempo -->
        <div style="
          position: absolute;
          bottom: 16px;
          left: 16px;
          background: white;
          padding: 8px 12px;
          border-radius: 20px;
          box-shadow: 0 2px 12px rgba(0,0,0,0.15);
          font-size: 0.75rem;
          display: flex;
          align-items: center;
          gap: 8px;
        ">
          <div style="color: var(--brand-600); font-weight: 600;">
            <i class="bi bi-signpost-2"></i> ${distance} km
          </div>
          <div style="color: #666; border-left: 1px solid #ddd; padding-left: 8px;">
            <i class="bi bi-clock"></i> ~${Math.round(distance * 2)} min
          </div>
        </div>

        <!-- Coordenadas -->
        <div style="
          position: absolute;
          bottom: 16px;
          right: 16px;
          background: rgba(0,0,0,0.7);
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 0.65rem;
          font-family: monospace;
        ">
          ${lat.toFixed(4)}, ${lng.toFixed(4)}
        </div>
      </div>
    `;

    mapContainer.innerHTML = mapHTML;
    console.log('‚úÖ Mapa de prueba creado exitosamente');
  }



  // Limpiar mapa cuando se cierre el modal
  document.getElementById('schoolDrawer')?.addEventListener('hidden.bs.offcanvas', function() {
    console.log('üö™ Modal cerrado, limpiando mapa...');
    if (drawerMapInstance) {
      drawerMapInstance.remove();
      drawerMapInstance = null;
      console.log('‚úÖ Mapa limpiado');
    }
  });

  // Agregar event listeners a los tabs
  document.addEventListener('DOMContentLoaded', function() {
    // Marcar todas las tarjetas de escuela para facilitar el filtrado
    document.querySelectorAll('article.card').forEach(card => {
      card.setAttribute('data-school-card', 'true');
    });
    
    // Agregar listeners a los tabs
    document.querySelector('[data-bs-target="#tabTodos"]')?.addEventListener('click', () => handleTabClick('todos'));
    document.querySelector('[data-bs-target="#tabTop"]')?.addEventListener('click', () => handleTabClick('top'));
    document.querySelector('[data-bs-target="#tabBilingues"]')?.addEventListener('click', () => handleTabClick('bilingues'));
    document.querySelector('[data-bs-target="#tabValorados"]')?.addEventListener('click', () => handleTabClick('valorados'));
    
    // Initialize filters
    updateFilters();
    
    // Event listener para limpiar filtros
    document.getElementById('clearAllFilters')?.addEventListener('click', clearAllFilters);
    
    // ===== INICIALIZACI√ìN DE COMPARACI√ìN =====
    // Event listener para abrir el modal de comparaci√≥n
    const compareBtnFinal = document.getElementById('compareBtn');
    if(compareBtnFinal) {
      compareBtnFinal.addEventListener('click', () => {
        console.log('üîç Bot√≥n comparar clickeado');
        generateComparisonContent();
      });
    }
    
    // Event listener para cuando se abra el offcanvas de comparaci√≥n (Bootstrap event)
    const compareOffcanvas = document.getElementById('compareOffcanvas');
    if(compareOffcanvas) {
      compareOffcanvas.addEventListener('show.bs.offcanvas', () => {
        console.log('üìä Offcanvas de comparaci√≥n abri√©ndose');
        
        // Si no hay escuelas guardadas, agregar algunas de prueba para mostrar el funcionamiento
        const savedSchools = getSavedSchools();
        if(savedSchools.length === 0) {
          // Agregar las primeras 2 escuelas como ejemplo
          const firstTwoSchools = allSchools.slice(0, 2);
          firstTwoSchools.forEach(school => {
            addSaved(school.id);
          });
        }
        
        generateComparisonContent();
        initComparisonTabs();
      });
    }
    
    // Event listener para el bot√≥n de limpiar comparaci√≥n
    const clearComparisonBtnFinal = document.getElementById('clearComparisonBtn');
    if(clearComparisonBtnFinal) {
      clearComparisonBtnFinal.addEventListener('click', () => {
        console.log('üóëÔ∏è Limpiando comparaci√≥n');
        
        // Confirmar antes de limpiar
        if(confirm('¬øEst√°s seguro de que quieres remover todas las escuelas de la comparaci√≥n?')) {
          const saved = getSaved();
          
          // Actualizar todas las tarjetas guardadas
          saved.forEach(id => {
            const schoolCard = $(`.sf-card[data-id="${id}"]`);
            if(schoolCard) {
              const saveBtn = schoolCard.querySelector('.js-save');
              if(saveBtn) {
                saveBtn.setAttribute('aria-pressed', 'false');
                saveBtn.innerHTML = '<i class="bi bi-bookmark"></i>';
              }
            }
          });
          
          setSaved([]);
          
          // Regenerar contenido
          generateComparisonContent();
          
          // Mostrar notificaci√≥n
          showNotification('Se han removido todas las escuelas de la comparaci√≥n', 'info');
        }
      });
    }
  });

  // ===== SISTEMA DE DIRECCIONES Y RUTAS =====
  let currentUserLocation = null;
  let directionsService = null;
  let directionsRenderer = null;
  let routeMap = null;
  let routingControl = null;

  // Obtener ubicaci√≥n del usuario
  function getUserLocation() {
    return new Promise((resolve, reject) => {
      if (currentUserLocation) {
        resolve(currentUserLocation);
        return;
      }

      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            currentUserLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            resolve(currentUserLocation);
          },
          (error) => {
            console.warn('No se pudo obtener la ubicaci√≥n:', error);
            // Ubicaci√≥n por defecto (San Juan, PR)
            currentUserLocation = { lat: 18.4655, lng: -66.1057 };
            resolve(currentUserLocation);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
        );
      } else {
        // Ubicaci√≥n por defecto si no hay geolocalizaci√≥n
        currentUserLocation = { lat: 18.4655, lng: -66.1057 };
        resolve(currentUserLocation);
      }
    });
  }

  // Inicializar mapa de rutas con trazado
  function initRouteMap(schoolLocation) {
    if (!routeMap) {
      routeMap = L.map('routeMap').setView([18.4655, -66.1057], 11);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(routeMap);
    }

    // Limpiar mapa anterior
    routeMap.eachLayer((layer) => {
      if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.Control) {
        if (layer !== routeMap._layers[Object.keys(routeMap._layers)[0]]) { // Mantener tile layer
          routeMap.removeLayer(layer);
        }
      }
    });

    // Remover control de routing anterior si existe
    if (routingControl) {
      routeMap.removeControl(routingControl);
      routingControl = null;
    }

    return getUserLocation().then((userLoc) => {
      // Crear iconos personalizados
      const userIcon = L.divIcon({
        html: `
          <div style="
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
          ">
            <i class="bi bi-geo-alt-fill" style="color: white; font-size: 14px;"></i>
          </div>
        `,
        iconSize: [24, 24],
        iconAnchor: [12, 12],
        className: 'custom-div-icon'
      });

      const schoolIcon = L.divIcon({
        html: `
          <div style="
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--brand), var(--brand-600));
            border: 3px solid white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(78, 113, 132, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
          ">
            <i class="bi bi-building" style="color: white; font-size: 16px;"></i>
          </div>
        `,
        iconSize: [28, 28],
        iconAnchor: [14, 14],
        className: 'custom-div-icon'
      });

      // Agregar marcadores
      const userMarker = L.marker([userLoc.lat, userLoc.lng], { icon: userIcon })
        .addTo(routeMap)
        .bindPopup(`
          <div style="text-align: center; padding: 8px;">
            <strong style="color: var(--brand-700);">Tu ubicaci√≥n</strong><br>
            <small style="color: #6b7280;">Punto de partida</small>
          </div>
        `);

      const schoolMarker = L.marker([schoolLocation.lat, schoolLocation.lng], { icon: schoolIcon })
        .addTo(routeMap)
        .bindPopup(`
          <div style="text-align: center; padding: 8px;">
            <strong style="color: var(--brand-700);">Escuela</strong><br>
            <small style="color: #6b7280;">Destino</small>
          </div>
        `);

      // Crear ruta trazada
      drawRoute(userLoc, schoolLocation);

      return { userLocation: userLoc, schoolLocation };
    });
  }

  // Funci√≥n para trazar la ruta en el mapa
  function drawRoute(startPoint, endPoint, transportMode = 'driving') {
    // Simular puntos de ruta realistas
    const routePoints = generateRealisticRoute(startPoint, endPoint, transportMode);
    
    // Crear polyline con estilo elegante
    const routeColors = {
      driving: '#3b82f6',    // Azul para auto
      transit: '#10b981',    // Verde para transporte p√∫blico
      walking: '#f59e0b'     // Naranja para caminar
    };

    const routePolyline = L.polyline(routePoints, {
      color: routeColors[transportMode] || routeColors.driving,
      weight: 5,
      opacity: 0.8,
      smoothFactor: 1,
      dashArray: transportMode === 'walking' ? '10, 10' : null
    }).addTo(routeMap);

    // Agregar animaci√≥n de pulso en la ruta
    const animatedPolyline = L.polyline(routePoints, {
      color: routeColors[transportMode] || routeColors.driving,
      weight: 8,
      opacity: 0.3,
      smoothFactor: 1,
      className: 'route-pulse'
    }).addTo(routeMap);

    // Ajustar vista para mostrar toda la ruta
    const bounds = L.latLngBounds(routePoints);
    routeMap.fitBounds(bounds, { padding: [30, 30] });

    // Agregar puntos de inter√©s en la ruta si es transporte p√∫blico
    if (transportMode === 'transit') {
      addTransitStops(routePoints);
    }

    return routePolyline;
  }

  // Generar ruta realista entre dos puntos
  function generateRealisticRoute(start, end, mode) {
    const points = [];
    points.push([start.lat, start.lng]);

    // N√∫mero de puntos intermedios seg√∫n el modo de transporte
    const numPoints = mode === 'walking' ? 3 : mode === 'transit' ? 6 : 4;
    
    // Generar puntos intermedios que simulen calles reales
    for (let i = 1; i < numPoints; i++) {
      const progress = i / numPoints;
      
      // Interpolaci√≥n con variaci√≥n para simular calles
      const lat = start.lat + (end.lat - start.lat) * progress + (Math.random() - 0.5) * 0.01;
      const lng = start.lng + (end.lng - start.lng) * progress + (Math.random() - 0.5) * 0.01;
      
      points.push([lat, lng]);
    }

    points.push([end.lat, end.lng]);
    return points;
  }

  // Agregar paradas de transporte p√∫blico
  function addTransitStops(routePoints) {
    const stopIcon = L.divIcon({
      html: `
        <div style="
          width: 16px;
          height: 16px;
          background: #10b981;
          border: 2px solid white;
          border-radius: 50%;
          box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        "></div>
      `,
      iconSize: [16, 16],
      iconAnchor: [8, 8],
      className: 'custom-div-icon'
    });

    // Agregar paradas en puntos intermedios
    for (let i = 2; i < routePoints.length - 2; i += 2) {
      L.marker(routePoints[i], { icon: stopIcon })
        .addTo(routeMap)
        .bindPopup(`
          <div style="text-align: center; padding: 6px;">
            <strong style="color: var(--brand-700); font-size: 0.85rem;">Parada ${Math.floor(i/2)}</strong><br>
            <small style="color: #6b7280;">Transporte p√∫blico</small>
          </div>
        `);
    }
  }

  // Calcular ruta y distancia
  function calculateRoute(origin, destination, mode = 'driving') {
    return new Promise((resolve) => {
      // Simular c√°lculo de ruta (en producci√≥n usar√≠as Google Directions API)
      const distance = calculateDistance(origin.lat, origin.lng, destination.lat, destination.lng);
      
      let time, trafficMultiplier;
      
      switch (mode) {
        case 'driving':
          time = Math.round(distance * 1.5); // ~1.5 min por km
          trafficMultiplier = getCurrentTrafficMultiplier();
          time = Math.round(time * trafficMultiplier);
          break;
        case 'transit':
          time = Math.round(distance * 2.5); // ~2.5 min por km
          break;
        case 'walking':
          time = Math.round(distance * 12); // ~12 min por km
          break;
      }

      resolve({
        distance: distance.toFixed(1),
        time: time,
        mode: mode,
        trafficCondition: getTrafficCondition(trafficMultiplier)
      });
    });
  }

  // Calcular distancia entre dos puntos (f√≥rmula de Haversine)
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radio de la Tierra en km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  // Obtener multiplicador de tr√°fico seg√∫n la hora
  function getCurrentTrafficMultiplier() {
    const now = new Date();
    const hour = now.getHours();
    
    // Horarios de mayor tr√°fico
    if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 18)) {
      return 1.8; // Tr√°fico pesado
    } else if (hour >= 12 && hour <= 13) {
      return 1.3; // Tr√°fico moderado
    }
    return 1.0; // Tr√°fico normal
  }

  // Obtener condici√≥n de tr√°fico
  function getTrafficCondition(multiplier) {
    if (multiplier >= 1.6) {
      return { level: 'heavy', text: 'Tr√°fico pesado', class: 'heavy' };
    } else if (multiplier >= 1.2) {
      return { level: 'moderate', text: 'Tr√°fico moderado', class: 'moderate' };
    }
    return { level: 'normal', text: 'Tr√°fico normal', class: 'normal' };
  }

  // Generar instrucciones paso a paso
  function generateStepByStepInstructions(origin, destination, mode) {
    const instructions = [];
    
    switch (mode) {
      case 'driving':
        instructions.push(
          '1. Dir√≠gete hacia el norte por la carretera principal',
          '2. Contin√∫a por 5.2 km',
          '3. Gira a la derecha en la Calle Principal',
          '4. Despu√©s de 800 m, gira a la izquierda',
          '5. Tu destino estar√° a la derecha'
        );
        break;
      case 'transit':
        instructions.push(
          '1. Camina hasta la parada de autob√∫s m√°s cercana (3 min)',
          '2. Toma la ruta B21 hacia el centro',
          '3. Transborda en la estaci√≥n central',
          '4. Toma la ruta A15 hacia tu destino',
          '5. B√°jate en la parada cerca de la escuela',
          '6. Camina 2 cuadras hasta la escuela'
        );
        break;
      case 'walking':
        instructions.push(
          '1. Dir√≠gete hacia el este por la acera',
          '2. Cruza la calle en el sem√°foro',
          '3. Contin√∫a derecho por 15 minutos',
          '4. Gira a la derecha en la esquina',
          '5. La escuela estar√° a tu izquierda'
        );
        break;
    }
    
    return instructions;
  }

  // Evento para abrir modal de direcciones
  document.addEventListener('click', async (e) => {
    if (e.target.closest('.js-directions')) {
      const btn = e.target.closest('.js-directions');
      const schoolId = btn.dataset.id;
      
      // Buscar datos de la escuela
      const schoolData = realSchoolsData.find(s => s.id == schoolId) || {
        name: 'Escuela Seleccionada',
        location: 'Municipio, PR',
        coordinates: { lat: 18.4655 + (Math.random() - 0.5) * 0.1, lng: -66.1057 + (Math.random() - 0.5) * 0.1 }
      };

      // Actualizar informaci√≥n en el modal
      document.querySelector('.directions-school-name').textContent = 
        `${schoolData.name} - ${schoolData.location}`;

      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('directionsModal'));
      modal.show();

      // Inicializar mapa cuando el modal se muestre completamente
      setTimeout(async () => {
        const locations = await initRouteMap(schoolData.coordinates);
        updateRouteInfo(locations.userLocation, locations.schoolLocation, 'driving');
      }, 300);
    }
  });

  // Cambio de modo de transporte
  document.querySelectorAll('input[name="transportMode"]').forEach(radio => {
    radio.addEventListener('change', async (e) => {
      const mode = e.target.value;
      const userLoc = await getUserLocation();
      
      // Obtener las coordenadas de la escuela actual del modal
      const schoolName = document.querySelector('.directions-school-name').textContent;
      const schoolData = realSchoolsData.find(s => schoolName.includes(s.name)) || {
        coordinates: { lat: 18.4655, lng: -66.1057 }
      };
      
      updateRouteInfo(userLoc, schoolData.coordinates, mode);
    });
  });

  // Actualizar informaci√≥n de ruta con trazado visual
  async function updateRouteInfo(origin, destination, mode) {
    const routeData = await calculateRoute(origin, destination, mode);
    
    document.getElementById('routeDistance').textContent = `${routeData.distance} km`;
    document.getElementById('routeTime').textContent = `${routeData.time} min`;
    
    const trafficElement = document.getElementById('trafficConditions');
    const trafficLight = trafficElement.querySelector('.traffic-light');
    
    trafficLight.className = `traffic-light ${routeData.trafficCondition.class}`;
    trafficElement.childNodes[2].textContent = routeData.trafficCondition.text;

    // Trazar nueva ruta en el mapa
    if (routeMap) {
      drawRoute(origin, destination, mode);
    }

    // Actualizar instrucciones
    const instructions = generateStepByStepInstructions(origin, destination, mode);
    const instructionsContainer = document.getElementById('stepByStepInstructions');
    
    instructionsContainer.innerHTML = instructions.map((instruction, index) => `
      <div class="instruction-step">
        <span class="step-number">${index + 1}</span>
        <span class="step-text">${instruction}</span>
      </div>
    `).join('');
  }

  // Abrir en Google Maps
  document.getElementById('openExternalMap').addEventListener('click', async () => {
    const userLoc = await getUserLocation();
    const schoolName = document.querySelector('.directions-school-name').textContent;
    const url = `https://www.google.com/maps/dir/${userLoc.lat},${userLoc.lng}/${encodeURIComponent(schoolName)}`;
    window.open(url, '_blank');
  });

</script>
</body>
</html>
